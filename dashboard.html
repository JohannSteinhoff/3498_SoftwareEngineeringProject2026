<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Tender</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        (function() {
            var theme = localStorage.getItem('tender_theme');
            if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF6B6B;
            --primary-dark: #ee5a5a;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --dark: #2C3E50;
            --light: #F7F9FC;
            --gradient: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            --bg-primary: #F7F9FC;
            --bg-card: #ffffff;
            --bg-card-hover: #fafafa;
            --bg-input: #ffffff;
            --text-primary: #2C3E50;
            --text-secondary: #888888;
            --text-tertiary: #aaaaaa;
            --border-color: #e0e0e0;
            --border-light: #f0f0f0;
            --shadow-color: rgba(0,0,0,0.05);
            --overlay-bg: rgba(0,0,0,0.5);
            --scrollbar-track: #eef2f9;
            --scrollbar-thumb: #ff8e53;
            --scrollbar-thumb-hover: #ff6b6b;
        }

        html.dark-mode {
            --bg-primary: #1a1a2e;
            --bg-card: #16213e;
            --bg-card-hover: #1a2744;
            --bg-input: #1e2a47;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0b0;
            --text-tertiary: #707080;
            --border-color: #2a3a5c;
            --border-light: #222b45;
            --shadow-color: rgba(0,0,0,0.2);
            --overlay-bg: rgba(0,0,0,0.7);
            --dark: #e8e8e8;
            --light: #1a1a2e;
            --scrollbar-track: #1f2a45;
            --scrollbar-thumb: #4ecdc4;
            --scrollbar-thumb-hover: #6ee1d9;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            min-height: 100vh;
            color: var(--dark);
        }

        /* Themed scrollbars */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }

        *::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        *::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 999px;
        }

        *::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--scrollbar-thumb) 0%, var(--scrollbar-thumb-hover) 100%);
            border-radius: 999px;
            border: 3px solid var(--scrollbar-track);
        }

        *::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        *::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Navigation */
        nav {
            background: var(--bg-card);
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5em;
            font-weight: 800;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-menu a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background 0.3s, color 0.3s;
            cursor: pointer;
        }

        .nav-menu a:hover, .nav-menu a.active {
            background: rgba(255, 107, 107, 0.1);
            color: var(--primary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .logout-btn {
            background: none;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s, color 0.3s;
            font-family: inherit;
        }

        .logout-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .main-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 3%;
        }

        /* Page views - only active one is visible */
        .page-view {
            display: none;
        }

        .page-view.active {
            display: block;
        }

        /* ============================================
           DASHBOARD (HOME) PAGE
           ============================================ */

        .welcome-section {
            background: var(--gradient);
            border-radius: 20px;
            padding: 40px;
            color: white;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .welcome-text h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .welcome-text p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .start-swiping-btn {
            background: var(--bg-card);
            color: var(--primary);
            border: none;
            padding: 15px 35px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            font-family: inherit;
        }

        .start-swiping-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .stat-card .icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 2em;
            color: var(--dark);
        }

        .stat-card p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Section Card */
        .section-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header a {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
        }

        /* Liked Recipes */
        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .recipe-card {
            background: var(--light);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .recipe-image {
            height: 100px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
        }

        .recipe-image.has-img {
            background: none;
        }

        .recipe-image.has-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recipe-image .emoji-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            font-size: 1.2em;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 2px 5px;
            line-height: 1;
        }

        .recipe-info {
            padding: 12px;
        }

        .recipe-info h4 {
            font-size: 0.95em;
            margin-bottom: 4px;
        }

        .recipe-info p {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .recipe-card .recipe-delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
        }

        .recipe-card:hover .recipe-delete-btn {
            opacity: 1;
        }

        .recipe-delete-btn:hover {
            background: #ff4444;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* Grocery List (dashboard preview) */
        .grocery-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .grocery-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s;
        }

        .grocery-item:hover {
            background: var(--light);
        }

        .grocery-item:last-child {
            border-bottom: none;
        }

        .grocery-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .grocery-item.checked span {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .grocery-item span {
            flex: 1;
        }

        .grocery-item .quantity {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .grocery-item .delete-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.2s;
        }

        .grocery-item .delete-btn:hover {
            color: var(--primary);
        }

        .add-grocery-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
        }

        .add-grocery-form input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
        }

        .add-grocery-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .add-grocery-form button {
            background: var(--gradient);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-family: inherit;
        }

        /* Profile Section */
        .profile-section {
            margin-top: 30px;
        }

        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .profile-field {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
        }

        .profile-field label {
            font-size: 0.85em;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 5px;
        }

        .profile-field span {
            font-weight: 500;
        }

        .preferences-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .tag {
            background: rgba(255, 107, 107, 0.1);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .security-section {
            margin-top: 20px;
            padding: 18px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
        }

        .security-section h3 {
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .security-section p {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .security-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            align-items: end;
        }

        .security-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .security-field label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .security-field input {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95em;
        }

        .security-field input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .security-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .security-actions #changePasswordBtn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .security-status {
            font-size: 0.85em;
            min-height: 1.2em;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .security-status.error {
            color: var(--primary);
        }

        .security-status.success {
            color: var(--secondary);
        }

        /* Edit Profile Modal */
        .edit-profile-form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .edit-profile-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .edit-profile-form label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--dark);
        }

        .edit-profile-form input,
        .edit-profile-form select {
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        .edit-profile-form input:focus,
        .edit-profile-form select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .edit-profile-form .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .edit-profile-form .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 400;
            font-size: 0.9em;
            background: var(--light);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-profile-form .checkbox-group label:has(input:checked) {
            background: rgba(255, 107, 107, 0.15);
            color: var(--primary);
        }

        .edit-profile-form .checkbox-group input {
            width: 16px;
            height: 16px;
            padding: 0;
            accent-color: var(--primary);
        }

        .edit-profile-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 500px) {
            .edit-profile-form .form-row {
                grid-template-columns: 1fr;
            }
        }

        .edit-profile-actions {
            display: flex;
            gap: 10px;
            padding: 0 30px 30px;
        }

        .edit-profile-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-save-profile {
            background: var(--gradient);
            color: white;
            border: none;
        }

        .btn-save-profile:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .btn-save-profile:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-cancel-profile {
            background: var(--bg-card);
            color: var(--dark);
            border: 2px solid var(--border-color);
        }

        .btn-cancel-profile:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* ============================================
           DISCOVER PAGE
           ============================================ */

        .discover-carousel {
            position: relative;
            margin-bottom: 24px;
            border-radius: 16px;
            border: 1px solid var(--border-light);
            background: linear-gradient(180deg, rgba(78, 205, 196, 0.08), rgba(255, 107, 107, 0.06));
            overflow: hidden;
            padding: 14px 0;
        }

        .discover-carousel::before,
        .discover-carousel::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 42px;
            z-index: 2;
            pointer-events: none;
        }

        .discover-carousel::before {
            left: 0;
            background: linear-gradient(90deg, var(--bg-primary) 10%, transparent 100%);
        }

        .discover-carousel::after {
            right: 0;
            background: linear-gradient(270deg, var(--bg-primary) 10%, transparent 100%);
        }

        .discover-carousel-track {
            --discover-carousel-duration: 18s;
            display: flex;
            align-items: center;
            gap: 16px;
            width: max-content;
            padding: 0 14px;
            animation: discover-carousel-scroll var(--discover-carousel-duration) linear infinite;
            will-change: transform;
        }

        .discover-carousel-item {
            width: 230px;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 12px;
            padding: 10px;
            min-height: 86px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .discover-carousel-thumb {
            width: 92px;
            height: 66px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .discover-carousel-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .discover-carousel-name {
            color: var(--text-primary);
            font-size: 0.92em;
            font-weight: 600;
            line-height: 1.25;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-align: left;
        }

        @keyframes discover-carousel-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        .discover-header {
            margin-bottom: 30px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 15px;
        }

        .discover-header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .discover-header p {
            color: var(--text-secondary);
        }

        .btn-create-recipe {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-create-recipe:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .edit-profile-form textarea {
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95em;
            transition: border-color 0.3s;
            resize: vertical;
            min-height: 80px;
        }

        .edit-profile-form textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 107, 0.03);
        }

        .image-upload-area.has-image {
            border-style: solid;
            border-color: var(--secondary);
            padding: 0;
        }

        .image-upload-area .upload-placeholder {
            color: var(--text-tertiary);
            font-size: 0.9em;
        }

        .image-upload-area .upload-placeholder span {
            font-size: 2em;
            display: block;
            margin-bottom: 6px;
        }

        .image-upload-area img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
        }

        .image-upload-area .remove-image-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .image-upload-area .remove-image-btn:hover {
            background: var(--primary);
        }

        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-bar input {
            flex: 1;
            min-width: 250px;
            padding: 14px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-bar select {
            padding: 14px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
            background: var(--bg-card);
            cursor: pointer;
            min-width: 160px;
        }

        .search-bar select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-chips {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 8px 18px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .filter-chip:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .dietary-filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .dietary-filter-label {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .dietary-filter-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .dietary-chip {
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            font-size: 0.82em;
            transition: all 0.3s;
            user-select: none;
            text-transform: capitalize;
        }

        .dietary-chip:hover {
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .dietary-chip.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        /* Favorites Fullscreen View */
        .favorites-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--light);
            z-index: 999;
            overflow-y: auto;
        }

        .favorites-overlay.active {
            display: block;
        }

        .favorites-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px 60px;
        }

        .favorites-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .favorites-header h1 {
            font-size: 2em;
        }

        .favorites-header p {
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .favorites-back-btn {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 20px;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .favorites-back-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .favorites-empty {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .favorites-empty .empty-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .favorites-empty h2 {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .discover-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .discover-recipe-card {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .discover-recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .discover-recipe-image {
            height: 160px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            position: relative;
        }

        .discover-recipe-image.has-img {
            background: #222;
        }

        .discover-recipe-image.has-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .discover-recipe-image .emoji-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 1.8em;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 2px 6px;
            line-height: 1;
            z-index: 1;
        }

        .discover-recipe-image .difficulty-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--overlay-bg);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.25em;
            font-weight: 500;
            text-transform: capitalize;
        }

        .discover-recipe-image .cuisine-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255,255,255,0.9);
            color: var(--dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.25em;
            font-weight: 500;
            text-transform: capitalize;
        }

        .discover-recipe-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .discover-recipe-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 6px;
        }

        .discover-recipe-body h3 {
            font-size: 1.15em;
            margin: 0;
        }

        .discover-recipe-body .description {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .discover-recipe-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .discover-recipe-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .discover-recipe-meta .likes-count {
            color: var(--primary);
            font-weight: 600;
        }

        .discover-admin-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .card-icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s, color 0.2s;
        }

        .card-icon-btn.edit {
            background: rgba(78, 205, 196, 0.14);
            color: var(--secondary);
        }

        .card-icon-btn.edit:hover {
            background: var(--secondary);
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(78, 205, 196, 0.3);
        }

        .card-icon-btn.delete {
            background: rgba(220, 53, 69, 0.12);
            color: #dc3545;
        }

        .card-icon-btn.delete:hover {
            background: #dc3545;
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(220, 53, 69, 0.3);
        }

        .discover-recipe-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: auto;
            padding-top: 16px;
        }

        .btn-like, .btn-add-plan {
            min-height: 52px;
            padding: 0 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-like {
            background: rgba(255, 107, 107, 0.1);
            color: var(--primary);
        }

        .btn-like:hover {
            background: var(--primary);
            color: white;
        }

        .btn-like.liked {
            background: var(--primary);
            color: white;
        }

        .btn-add-plan {
            background: rgba(78, 205, 196, 0.1);
            color: var(--secondary);
        }

        .btn-add-plan:hover {
            background: var(--secondary);
            color: white;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            grid-column: 1 / -1;
        }

        .no-results .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* Recipe Detail Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Make opened recipe details wider than generic dialogs */
        #recipeModal .modal {
            max-width: 760px;
        }

        .modal-header {
            background: var(--gradient);
            padding: 30px;
            color: white;
            display: flex;
            align-items: center;
            gap: 20px;
            border-radius: 20px 20px 0 0;
        }

        .modal-header .emoji {
            font-size: 3em;
        }

        .modal-header h2 {
            font-size: 1.5em;
        }

        #recipeModal .modal-header {
            align-items: flex-start;
        }

        #recipeModal .modal-header .header-content {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            flex: 1;
            min-width: 0;
            padding-right: 48px;
        }

        #recipeModal .modal-header .header-text {
            flex: 1;
            min-width: 0;
        }

        #recipeModal .modal-header .header-text h2 {
            margin: 0 0 4px;
            overflow-wrap: anywhere;
        }

        .modal-source-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 11px;
            border-radius: 999px;
            border: 1px solid var(--secondary);
            background: var(--secondary);
            color: #fff;
            text-decoration: none;
            font-size: 0.8em;
            font-weight: 600;
            transition: background 0.2s, border-color 0.2s;
            white-space: nowrap;
        }

        #recipeModal .modal-source-link {
            margin-left: auto;
            align-self: flex-start;
            flex-shrink: 0;
        }

        .modal-source-link:hover {
            background: #3ab5ad;
            border-color: #3ab5ad;
        }

        .modal-header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-body h3 {
            font-size: 1.1em;
            margin-bottom: 12px;
            color: var(--dark);
        }

        .modal-body ul {
            list-style: none;
            margin-bottom: 25px;
        }

        .modal-body ul li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-body ul li::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            flex-shrink: 0;
        }

        .modal-body .instructions {
            line-height: 1.8;
            color: var(--text-secondary);
            white-space: pre-line;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            padding: 0 30px 30px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 1em;
            transition: all 0.3s;
        }

        .modal-btn-like {
            background: var(--gradient);
            color: white;
        }

        .modal-btn-grocery {
            background: rgba(78, 205, 196, 0.15);
            color: var(--secondary);
        }

        .modal-btn-grocery:hover {
            background: var(--secondary);
            color: white;
        }

        .modal-btn-delete {
            background: rgba(220, 53, 69, 0.12);
            color: #dc3545;
        }

        .modal-btn-delete:hover {
            background: #dc3545;
            color: white;
        }

        .btn-delete-recipe {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.3s;
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .btn-delete-recipe:hover {
            background: #dc3545;
            color: white;
        }

        .btn-edit-recipe {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.3s;
            background: rgba(78, 205, 196, 0.12);
            color: var(--secondary);
        }

        .btn-edit-recipe:hover {
            background: var(--secondary);
            color: white;
        }

        .modal-btn-edit {
            background: rgba(78, 205, 196, 0.12);
            color: var(--secondary);
        }

        .modal-btn-edit:hover {
            background: var(--secondary);
            color: white;
        }

        .admin-badge {
            display: inline-block;
            background: var(--gradient);
            color: white;
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
            vertical-align: middle;
        }

        .admin-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 107, 107, 0.05);
            border: 1px solid rgba(255, 107, 107, 0.15);
            border-radius: 12px;
        }

        .admin-section h3 {
            margin-bottom: 12px;
            color: var(--primary);
            font-size: 1em;
        }

        .admin-promote-form {
            display: flex;
            gap: 10px;
        }

        .admin-promote-form input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9em;
        }

        .admin-promote-form button {
            padding: 10px 20px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            white-space: nowrap;
        }

        .btn-become-admin {
            padding: 10px 20px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 0.9em;
        }

        .admin-users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 0.85em;
        }

        .admin-users-table th,
        .admin-users-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .admin-users-table th {
            background: rgba(255, 107, 107, 0.08);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .admin-users-table tr:hover td {
            background: rgba(255, 107, 107, 0.04);
        }

        .admin-users-table .admin-tag {
            display: inline-block;
            background: var(--gradient);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .admin-users-table .user-tag {
            display: inline-block;
            background: var(--border-color);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .admin-users-table .password-cell {
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.03);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.9em;
            user-select: all;
        }

        .admin-users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 4px;
        }

        .admin-users-header h3 {
            color: var(--primary);
            font-size: 1em;
            margin: 0;
        }

        .btn-refresh-users {
            padding: 6px 14px;
            background: rgba(78, 205, 196, 0.12);
            color: var(--secondary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 0.8em;
            transition: 0.2s;
        }

        .btn-refresh-users:hover {
            background: var(--secondary);
            color: white;
        }

        .admin-user-count {
            font-size: 0.8em;
            color: var(--text-tertiary);
            margin-top: 8px;
        }

        /* ============================================
           MEAL PLAN PAGE
           ============================================ */

        .mealplan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .mealplan-header h1 {
            font-size: 2em;
        }

        .mealplan-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .mealplan-nav button {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 8px 16px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.3s;
        }

        .mealplan-nav button:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .mealplan-nav .week-label {
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        .mealplan-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        @media (max-width: 1100px) {
            .mealplan-week {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 700px) {
            .mealplan-week {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .mealplan-day {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 15px var(--shadow-color);
            overflow: hidden;
            min-height: 280px;
        }

        .mealplan-day.today {
            border: 2px solid var(--primary);
        }

        .mealplan-day-header {
            background: var(--light);
            padding: 12px 15px;
            font-weight: 600;
            font-size: 0.9em;
            text-align: center;
        }

        .mealplan-day.today .mealplan-day-header {
            background: var(--gradient);
            color: white;
        }

        .mealplan-day-header .date {
            font-weight: 400;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .mealplan-day.today .mealplan-day-header .date {
            color: rgba(255,255,255,0.8);
        }

        .meal-slot {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s, border-color 0.2s, transform 0.2s;
        }

        .meal-slot:last-child {
            border-bottom: none;
        }

        .meal-slot.planned-slot {
            cursor: grab;
        }

        .meal-slot.planned-slot:active {
            cursor: grabbing;
        }

        .meal-slot.drag-origin {
            opacity: 0.35;
        }

        .meal-slot.open-slot.drop-target {
            border: 1px dashed var(--secondary);
            background: color-mix(in srgb, var(--secondary) 12%, transparent);
        }

        .meal-slot.slot-snap {
            animation: meal-slot-snap 0.26s ease-out;
        }

        @keyframes meal-slot-snap {
            0% { transform: scale(0.98); }
            70% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .meal-slot-drag-ghost {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 2200;
            opacity: 0.95;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.25);
            transform: translate(-18px, -18px);
        }

        .meal-slot-label {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            margin-bottom: 0;
        }

        .meal-slot-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px;
        }

        .meal-slot-add-side {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            border: 1px dashed var(--border-color);
            background: none;
            color: var(--text-tertiary);
            font-family: inherit;
            font-size: 0.95em;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s, background 0.2s;
            flex-shrink: 0;
        }

        .meal-slot-add-side:hover {
            border-color: var(--secondary);
            color: var(--secondary);
            background: color-mix(in srgb, var(--secondary) 10%, transparent);
        }

        .meal-slot-content {
            min-height: 40px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meal-recipe-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 0;
            background: none;
            border: none;
            padding: 4px 6px;
            margin: -4px -6px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            text-align: left;
            color: var(--text-primary);
            transition: background 0.18s;
        }

        .meal-recipe-btn:hover {
            background: var(--light);
        }

        .meal-recipe-btn:hover .meal-name {
            color: var(--primary);
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .meal-slot-content .meal-emoji {
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .meal-slot-content .meal-name {
            font-size: 0.85em;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: color 0.18s;
        }

        .meal-slot-content .remove-meal {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 1em;
            transition: color 0.2s;
        }

        .meal-slot-content .remove-meal:hover {
            color: var(--primary);
        }

        .meal-slot-empty {
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-meal-btn {
            background: none;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 8px;
            width: 100%;
            cursor: pointer;
            color: var(--text-tertiary);
            font-family: inherit;
            font-size: 0.8em;
            transition: all 0.3s;
        }

        .add-meal-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .meal-slot-side-content {
            margin-top: 4px;
            opacity: 0.85;
        }

        .meal-slot-side-content .meal-emoji {
            font-size: 1.1em;
        }

        .meal-slot-side-content .meal-name {
            font-size: 0.8em;
        }

        .meal-side-tag {
            font-size: 0.65em;
            font-weight: 700;
            color: var(--secondary);
            text-transform: uppercase;
            flex-shrink: 0;
            background: color-mix(in srgb, var(--secondary) 12%, transparent);
            padding: 1px 4px;
            border-radius: 4px;
        }

        /* Add to Meal Plan Modal */
        .add-meal-modal {
            align-items: flex-start;
        }

        .add-meal-modal .modal {
            max-width: 800px;
            margin-top: clamp(12px, 3vh, 36px);
        }

        .add-meal-modal .modal-body {
            padding: 22px 28px 28px;
        }

        .add-meal-filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
        }

        .add-meal-filter-btn {
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 8px 18px;
            font-size: 0.88em;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .add-meal-filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .add-meal-filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .recipe-select-list {
            max-height: 420px;
            overflow-y: auto;
            margin: 0 -4px;
            padding: 0 4px;
        }

        .recipe-select-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 11px 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.18s, border-color 0.18s;
            border: 1px solid transparent;
        }

        .recipe-select-item:hover {
            background: var(--light);
            border-color: var(--border-color);
        }

        .recipe-select-empty {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 28px 14px;
            color: var(--text-secondary);
            text-align: center;
            font-size: 0.9em;
            background: var(--bg-card);
        }

        .recipe-select-emoji {
            font-size: 1.8em;
            flex-shrink: 0;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            border-radius: 12px;
        }

        .recipe-select-info {
            flex: 1;
            min-width: 0;
        }

        .recipe-select-item .name {
            font-weight: 600;
            font-size: 0.95em;
            margin-bottom: 3px;
        }

        .recipe-select-item .time {
            font-size: 0.82em;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0;
            flex-wrap: wrap;
        }

        .rsi-dot {
            margin: 0 5px;
            color: var(--text-tertiary);
        }

        .rsi-cuisine {
            background: rgba(255,107,107,0.12);
            color: var(--primary);
            font-weight: 600;
            padding: 1px 8px;
            border-radius: 999px;
            font-size: 0.9em;
        }

        /* Add Meal Search */
        .add-meal-search-wrap {
            position: relative;
            margin-bottom: 14px;
        }

        .add-meal-search-wrap::before {
            content: '';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9em;
            pointer-events: none;
            z-index: 1;
        }

        .add-meal-search {
            width: 100%;
            box-sizing: border-box;
            padding: 11px 40px 11px 40px;
            border: 2px solid var(--border-color);
            border-radius: 999px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.92em;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .add-meal-search:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,107,107,0.12);
        }

        .add-meal-search-clear {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-tertiary);
            font-size: 1em;
            padding: 0;
            line-height: 1;
            display: none;
        }

        .add-meal-search-clear.visible {
            display: block;
        }

        /* Grocery day marker */
        .mealplan-day.grocery-day {
            border: 2px solid var(--secondary);
        }

        .grocery-day-btn {
            display: block;
            margin: 5px auto 0;
            background: none;
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 0.78em;
            padding: 2px 8px;
            border-radius: 6px;
            opacity: 0.3;
            transition: opacity 0.2s, background 0.2s, border-color 0.2s;
            font-family: inherit;
            line-height: 1.5;
            white-space: nowrap;
            color: var(--text-secondary);
        }

        .grocery-day-btn:hover {
            opacity: 0.75;
            background: rgba(78, 205, 196, 0.1);
            border-color: var(--secondary);
        }

        .mealplan-day.grocery-day .grocery-day-btn {
            opacity: 1;
            color: var(--secondary);
            background: rgba(78, 205, 196, 0.12);
            border-color: var(--secondary);
            font-weight: 600;
        }

        /* Two-week section headers */
        .week-section-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700;
            font-size: 0.95em;
            color: var(--text-secondary);
            padding: 6px 2px 10px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 14px;
        }

        .week-section-label + .week-section-label,
        .mealplan-week + .week-section-label {
            margin-top: 30px;
        }

        .week-section-range {
            font-weight: 400;
            font-size: 0.9em;
        }

        /* Meal Plan Summary */
        .mealplan-summary {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .mealplan-summary h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-stat {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .summary-stat:last-child {
            border-bottom: none;
        }

        .summary-stat .label {
            color: var(--text-secondary);
        }

        .summary-stat .value {
            font-weight: 600;
        }

        /* Selectable day cards */
        .mealplan-day .mealplan-day-header {
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .mealplan-day .mealplan-day-header:hover {
            opacity: 0.85;
        }

        .mealplan-day.selected {
            border: 2px solid var(--secondary);
        }

        .mealplan-day.selected .mealplan-day-header {
            background: var(--secondary);
            color: white;
        }

        .mealplan-day.selected .mealplan-day-header .date {
            color: rgba(255,255,255,0.8);
        }

        .mealplan-day.today.selected {
            border-color: var(--secondary);
        }

        .mealplan-day.today.selected .mealplan-day-header {
            background: linear-gradient(135deg, var(--secondary) 0%, #38d4c8 100%);
        }

        .select-check {
            position: absolute;
            top: 8px;
            right: 10px;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: transparent;
            transition: all 0.2s;
        }

        .mealplan-day.selected .select-check {
            background: var(--bg-card);
            border-color: white;
            color: var(--secondary);
        }

        /* Ingredient action bar */
        .ingredient-action-bar {
            position: sticky;
            bottom: 20px;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            padding: 16px 24px;
            margin-top: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            z-index: 50;
            animation: slideUp 0.3s ease;
        }

        .ingredient-action-bar.visible {
            display: flex;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .ingredient-bar-info {
            display: flex;
            flex-direction: column;
        }

        .ingredient-bar-info .bar-title {
            font-weight: 700;
            font-size: 0.95em;
        }

        .ingredient-bar-info .bar-subtitle {
            font-size: 0.82em;
            color: var(--text-secondary);
        }

        .ingredient-bar-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-add-ingredients {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-family: inherit;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-add-ingredients:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
        }

        .btn-clear-selection {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85em;
            padding: 8px;
            transition: color 0.2s;
        }

        .btn-clear-selection:hover {
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .ingredient-action-bar {
                bottom: 75px;
                margin-left: -5%;
                margin-right: -5%;
                border-radius: 16px 16px 0 0;
                flex-wrap: wrap;
            }
        }

        /* ============================================
           GROCERY LIST PAGE
           ============================================ */

        .grocery-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .grocery-page-header h1 {
            font-size: 2em;
        }

        .grocery-header-actions {
            display: flex;
            gap: 10px;
        }

        .grocery-header-actions button {
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.3s;
        }

        .btn-clear-all {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-clear-all:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .grocery-page-form {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .grocery-page-form input {
            flex: 1;
            min-width: 250px;
            padding: 14px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
        }

        .grocery-page-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .grocery-page-form input[type="number"] {
            max-width: 100px;
            min-width: 100px;
        }

        .grocery-page-form button {
            background: var(--gradient);
            border: none;
            color: white;
            padding: 14px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 1em;
            transition: transform 0.3s;
        }

        .grocery-page-form button:hover {
            transform: translateY(-2px);
        }

        .grocery-full-list {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 15px var(--shadow-color);
            overflow: hidden;
        }

        .grocery-category-header {
            background: var(--light);
            padding: 12px 20px;
            font-weight: 600;
            font-size: 0.95em;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grocery-full-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s;
        }

        .grocery-full-item:hover {
            background: rgba(255, 107, 107, 0.02);
        }

        .grocery-full-item:last-child {
            border-bottom: none;
        }

        .grocery-full-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .grocery-full-item.checked .item-name {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .grocery-full-item .item-name {
            flex: 1;
            font-weight: 500;
        }

        .grocery-full-item .item-quantity {
            background: var(--light);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .grocery-full-item .item-delete {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 1.3em;
            transition: color 0.2s;
            padding: 5px;
        }

        .grocery-full-item .item-delete:hover {
            color: var(--primary);
        }

        .grocery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .grocery-stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
        }

        .grocery-stat-card h3 {
            font-size: 1.8em;
            color: var(--primary);
        }

        .grocery-stat-card p {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* ============================================
           GROCERY/FRIDGE TABS
           ============================================ */

        .grocery-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .grocery-tab-btn {
            flex: 1;
            padding: 16px 20px;
            border: none;
            background: var(--bg-card);
            font-size: 1em;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s;
            position: relative;
        }

        .grocery-tab-btn.active {
            color: var(--primary);
            background: var(--light);
        }

        .grocery-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient);
        }

        .grocery-tab-btn:hover:not(.active) {
            color: var(--text-secondary);
            background: var(--bg-card-hover);
        }

        .grocery-tab-content {
            display: none;
        }

        .grocery-tab-content.active {
            display: block;
        }

        /* Fridge section */
        .fridge-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .fridge-actions form {
            display: flex;
            gap: 12px;
            flex: 1;
            flex-wrap: wrap;
        }

        .fridge-actions form input {
            flex: 1;
            min-width: 200px;
            padding: 14px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
        }

        .fridge-actions form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .fridge-actions form input[type="number"] {
            max-width: 100px;
            min-width: 100px;
        }

        .fridge-actions form button,
        .btn-scan-fridge {
            background: var(--gradient);
            border: none;
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 1em;
            transition: transform 0.3s;
            white-space: nowrap;
        }

        .fridge-actions form button:hover,
        .btn-scan-fridge:hover {
            transform: translateY(-2px);
        }

        .btn-scan-fridge {
            background: linear-gradient(135deg, #4ECDC4 0%, #44B3AA 100%);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fridge-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s;
        }

        .fridge-item:hover {
            background: rgba(78, 205, 196, 0.03);
        }

        .fridge-item:last-child {
            border-bottom: none;
        }

        .fridge-item .item-icon {
            font-size: 1.4em;
        }

        .fridge-item .item-name {
            flex: 1;
            font-weight: 500;
        }

        .fridge-item .item-quantity {
            background: #E8F8F5;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #2C7A6E;
        }

        .fridge-item .item-category {
            background: var(--border-light);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .fridge-item .item-delete {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 1.3em;
            transition: color 0.2s;
            padding: 5px;
        }

        .fridge-item .item-delete:hover {
            color: var(--primary);
        }

        /* Scan results modal */
        .scan-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-bg);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .scan-overlay.active {
            display: flex;
        }

        .scan-modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .scan-modal-header {
            padding: 25px 25px 15px;
            border-bottom: 1px solid var(--border-light);
        }

        .scan-modal-header h2 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .scan-modal-header p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .scan-modal-body {
            padding: 15px 25px;
        }

        .scan-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .scan-item:last-child {
            border-bottom: none;
        }

        .scan-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4ECDC4;
            cursor: pointer;
        }

        .scan-item .scan-item-name {
            flex: 1;
            font-weight: 500;
        }

        .scan-item .scan-item-qty {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .scan-item .scan-item-category {
            background: var(--border-light);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        .scan-modal-footer {
            padding: 15px 25px 25px;
            display: flex;
            gap: 12px;
        }

        .scan-modal-footer button {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-weight: 600;
            font-family: inherit;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .scan-modal-footer button:hover {
            transform: translateY(-1px);
        }

        .btn-scan-cancel {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-scan-confirm {
            background: linear-gradient(135deg, #4ECDC4 0%, #44B3AA 100%);
            border: none;
            color: white;
        }

        .scan-loading {
            text-align: center;
            padding: 40px 20px;
        }

        .scan-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-top-color: #4ECDC4;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           SWIPE PAGE
           ============================================ */

        .swipe-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: calc(100vh - 140px);
            padding-top: 10px;
            position: relative;
            z-index: 2;
        }

        .swipe-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: transparent;
            transition: background-color 0.2s ease;
            z-index: 0;
            pointer-events: none;
        }

        .swipe-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .swipe-header h1 {
            font-size: 2em;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .swipe-header p {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .swipe-counter {
            display: inline-block;
            background: rgba(255, 107, 107, 0.1);
            color: var(--primary);
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 8px;
        }

        .swipe-active-filters {
            display: flex;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .swipe-filter-tag {
            display: inline-block;
            background: rgba(78, 205, 196, 0.15);
            color: var(--secondary);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: capitalize;
        }

        .swipe-no-filters {
            display: inline-block;
            color: var(--text-tertiary);
            font-size: 0.75em;
            margin-top: 10px;
        }

        .swipe-difficulty-filters {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 10;
        }

        .swipe-diff-label {
            font-size: 0.68em;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 2px;
        }

        .swipe-diff-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 5px 14px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
            text-align: center;
            box-shadow: 0 2px 6px var(--shadow-color);
        }

        .swipe-diff-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .swipe-diff-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .swipe-diff-btn[data-diff="easy"].active {
            background: #4ade80;
            border-color: #4ade80;
            color: #fff;
        }

        .swipe-diff-btn[data-diff="medium"].active {
            background: #fb923c;
            border-color: #fb923c;
            color: #fff;
        }

        .swipe-diff-btn[data-diff="hard"].active {
            background: #f87171;
            border-color: #f87171;
            color: #fff;
        }

        .swipe-container {
            position: relative;
            width: 380px;
            height: 520px;
            margin: 0 auto;
        }

        .swipe-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            overflow: hidden;
            cursor: grab;
            user-select: none;
            touch-action: none;
            transition: box-shadow 0.3s;
            will-change: transform;
        }

        .swipe-card:active {
            cursor: grabbing;
            box-shadow: 0 15px 50px rgba(0,0,0,0.18);
        }

        .swipe-card.animating {
            transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1), opacity 0.4s ease;
        }

        .swipe-card-bg {
            position: relative;
            height: 55%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .swipe-card-bg-gradient {
            position: absolute;
            inset: 0;
            transition: opacity 0.3s;
        }

        .swipe-card-emoji {
            font-size: 6em;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
            transition: transform 0.3s;
        }

        .swipe-card-bg.has-img .swipe-card-bg-gradient {
            opacity: 0;
        }

        .swipe-card-bg.has-img .swipe-card-img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .swipe-card-bg.has-img .swipe-card-emoji {
            position: absolute;
            bottom: 8px;
            right: 10px;
            font-size: 1.8em;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 2px 6px;
            line-height: 1;
            filter: none;
        }

        /* Emoji Rain */
        .emoji-rain-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .emoji-rain-particle {
            position: absolute;
            top: -60px;
            animation: emoji-fall linear;
            will-change: transform;
            opacity: 0;
        }

        @keyframes emoji-fall {
            0% {
                transform: translateY(0) rotate(var(--start-rot));
                opacity: 0;
            }
            5% {
                opacity: var(--particle-opacity);
            }
            85% {
                opacity: var(--particle-opacity);
            }
            100% {
                transform: translateY(calc(100vh + 80px)) rotate(var(--end-rot));
                opacity: 0;
            }
        }

        .swipe-card:hover .swipe-card-emoji {
            transform: scale(1.05);
        }

        .swipe-card-cuisine {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(8px);
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--dark);
            z-index: 2;
        }

        .swipe-card-difficulty {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            z-index: 2;
        }

        .swipe-card-difficulty.easy { background: rgba(78, 205, 196, 0.2); color: #2aa89f; }
        .swipe-card-difficulty.medium { background: rgba(255, 230, 109, 0.3); color: #b8960a; }
        .swipe-card-difficulty.hard { background: rgba(255, 107, 107, 0.2); color: var(--primary); }

        /* Admin gluten-free toggle button on swipe card */
        .swipe-gf-btn {
            position: absolute;
            bottom: 14px;
            left: 14px;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(6px);
            border: 1.5px solid rgba(255, 255, 255, 0.35);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.75em;
            font-weight: 700;
            cursor: pointer;
            z-index: 10;
            font-family: inherit;
            transition: all 0.2s ease;
            letter-spacing: 0.04em;
        }

        .swipe-gf-btn:hover {
            background: rgba(0, 0, 0, 0.55);
            border-color: rgba(255, 255, 255, 0.7);
            color: white;
        }

        .swipe-gf-btn.active {
            background: rgba(74, 222, 128, 0.85);
            border-color: #4ade80;
            color: white;
        }

        .swipe-gf-btn.denied {
            background: rgba(248, 113, 113, 0.85);
            border-color: #f87171;
            color: white;
        }

        .swipe-card-body {
            padding: 22px 24px;
            height: 45%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .swipe-card-name {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 6px;
            line-height: 1.2;
        }

        .swipe-card-desc {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 14px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .swipe-card-stats {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .swipe-card-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.88em;
            color: var(--text-secondary);
        }

        .swipe-card-stat .stat-icon {
            font-size: 1.1em;
        }

        .swipe-card-ingredients-peek {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .swipe-card-ingredients-peek .ing-tag {
            background: var(--light);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        /* Swipe stamp overlays */
        .swipe-stamp {
            position: absolute;
            top: 50%;
            transform: translateY(-50%) rotate(-15deg);
            font-size: 3em;
            font-weight: 800;
            padding: 8px 20px;
            border-radius: 12px;
            border: 5px solid;
            opacity: 0;
            z-index: 10;
            pointer-events: none;
            transition: opacity 0.15s;
            text-transform: uppercase;
        }

        .swipe-stamp-like {
            right: 20px;
            color: var(--secondary);
            border-color: var(--secondary);
            background: rgba(78, 205, 196, 0.1);
        }

        .swipe-stamp-nope {
            left: 20px;
            color: var(--primary);
            border-color: var(--primary);
            background: rgba(255, 107, 107, 0.1);
            transform: translateY(-50%) rotate(15deg);
        }

        /* Action buttons */
        .swipe-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 28px;
        }

        .swipe-action-btn {
            width: 68px;
            height: 68px;
            border-radius: 50%;
            border: none;
            font-size: 1.6em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.2, 0, 0, 1);
            position: relative;
        }

        .swipe-action-btn::after {
            content: attr(data-label);
            position: absolute;
            bottom: -22px;
            font-size: 0.42em;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .swipe-action-btn:hover::after {
            opacity: 1;
        }

        .swipe-action-btn:active {
            transform: scale(0.9);
        }

        .swipe-btn-nope {
            background: var(--bg-card);
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.25);
            color: var(--primary);
        }

        .swipe-btn-nope:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.4);
        }

        .swipe-btn-nope::after { color: var(--primary); }

        .swipe-btn-info {
            width: 52px;
            height: 52px;
            background: var(--bg-card);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            color: var(--text-tertiary);
            font-size: 1.2em;
        }

        .swipe-btn-info:hover {
            color: var(--dark);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .swipe-btn-info::after { color: var(--text-secondary); }

        .swipe-btn-like {
            background: var(--secondary);
            box-shadow: 0 4px 20px rgba(78, 205, 196, 0.4);
            color: white;
        }

        .swipe-btn-like:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(78, 205, 196, 0.5);
        }

        .swipe-btn-like::after { color: var(--secondary); }

        .swipe-btn-superlike {
            width: 52px;
            height: 52px;
            background: var(--bg-card);
            box-shadow: 0 4px 15px rgba(255, 230, 109, 0.3);
            color: #f0c000;
            font-size: 1.2em;
        }

        .swipe-btn-superlike:hover {
            background: #f0c000;
            color: white;
            transform: scale(1.1);
        }

        .swipe-btn-superlike::after { color: #d4a800; }

        /* Empty state */
        .swipe-empty {
            text-align: center;
            padding: 60px 30px;
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            max-width: 380px;
            margin: 0 auto;
        }

        .swipe-empty .empty-icon {
            font-size: 4em;
            margin-bottom: 16px;
        }

        .swipe-empty h2 {
            font-size: 1.4em;
            margin-bottom: 8px;
        }

        .swipe-empty p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .swipe-empty button {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-family: inherit;
            font-size: 1em;
            cursor: pointer;
        }

        /* Card gradient backgrounds by cuisine */
        .cuisine-bg-italian { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .cuisine-bg-mexican { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .cuisine-bg-chinese { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .cuisine-bg-japanese { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .cuisine-bg-indian { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .cuisine-bg-thai { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .cuisine-bg-mediterranean { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .cuisine-bg-american { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .cuisine-bg-french { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
        .cuisine-bg-korean { background: linear-gradient(135deg, #f78ca0 0%, #f9748f 50%, #fd868c 100%); }
        .cuisine-bg-greek { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .cuisine-bg-vietnamese { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
        .cuisine-bg-british { background: linear-gradient(135deg, #c3cfe2 0%, #f5f7fa 100%); }
        .cuisine-bg-default { background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); }

        /* Schedule Recipe Modal */
        .schedule-picker {
            padding: 5px 0;
        }

        .schedule-label {
            display: block;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .schedule-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .schedule-day-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 4px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .schedule-day-btn:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 107, 0.05);
        }

        .schedule-day-btn.active {
            border-color: var(--primary);
            background: rgba(255, 107, 107, 0.1);
            color: var(--primary);
        }

        .schedule-day-btn.today {
            position: relative;
        }

        .schedule-day-btn.today::after {
            content: '';
            width: 5px;
            height: 5px;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
        }

        .schedule-day-btn .day-name {
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .schedule-day-btn.active .day-name {
            color: var(--primary);
        }

        .schedule-day-btn .day-num {
            font-size: 1.1em;
            font-weight: 700;
        }

        .schedule-day-btn .day-dots {
            display: flex;
            gap: 3px;
            margin-top: 4px;
            justify-content: center;
        }

        .schedule-day-btn .day-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--border-color);
        }

        .schedule-day-btn .day-dot.filled {
            background: var(--secondary);
        }

        .schedule-day-btn.active .day-dot.filled {
            background: var(--primary);
        }

        /* Day preview  shows what's planned for the selected day */
        .schedule-day-preview {
            margin-top: 14px;
            padding: 14px 16px;
            background: var(--light);
            border-radius: 12px;
            min-height: 50px;
        }

        .schedule-day-preview-title {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 8px;
        }

        .schedule-day-preview-empty {
            font-size: 0.85em;
            color: var(--text-tertiary);
            font-style: italic;
        }

        .schedule-preview-slot {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
        }

        .schedule-preview-slot + .schedule-preview-slot {
            border-top: 1px solid var(--border-light);
        }

        .schedule-preview-slot .slot-time {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            width: 65px;
            flex-shrink: 0;
        }

        .schedule-preview-slot .slot-recipe {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.88em;
        }

        .schedule-preview-slot .slot-recipe .slot-emoji {
            font-size: 1.2em;
        }

        .schedule-preview-slot .slot-empty {
            font-size: 0.85em;
            color: var(--text-tertiary);
        }

        /* Meal picker buttons */
        .schedule-meals {
            display: flex;
            gap: 10px;
        }

        .schedule-meal-btn {
            flex: 1;
            padding: 12px 8px 10px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.2s;
            text-align: center;
        }

        .schedule-meal-btn:hover {
            border-color: var(--secondary);
            background: rgba(78, 205, 196, 0.05);
        }

        .schedule-meal-btn.active {
            border-color: var(--secondary);
            background: rgba(78, 205, 196, 0.1);
            color: var(--secondary);
        }

        .schedule-meal-btn.occupied {
            border-style: dashed;
        }

        .schedule-meal-btn .meal-label {
            display: block;
        }

        .schedule-meal-btn .meal-existing {
            display: block;
            font-size: 0.78em;
            font-weight: 400;
            color: var(--text-tertiary);
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .schedule-meal-btn.active .meal-existing {
            color: var(--secondary);
        }

        @media (max-width: 480px) {
            .schedule-days {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ============================================
           MOBILE RESPONSIVE
           ============================================ */

        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .mobile-nav {
                display: flex !important;
            }

            .welcome-section {
                flex-direction: column;
                text-align: center;
            }

            .welcome-text h1 {
                font-size: 1.5em;
            }

            .discover-grid {
                grid-template-columns: 1fr;
            }

            .discover-carousel-item {
                width: 200px;
                min-height: 78px;
            }

            .discover-carousel-thumb {
                width: 78px;
                height: 56px;
            }

            .swipe-container {
                width: min(380px, calc(100vw - 40px));
                height: min(520px, calc(100vh - 300px));
            }

            .swipe-card-emoji {
                font-size: 4.5em;
            }

            .swipe-card-name {
                font-size: 1.3em;
            }

            .swipe-action-btn {
                width: 60px;
                height: 60px;
            }

            .swipe-btn-info, .swipe-btn-superlike {
                width: 46px;
                height: 46px;
            }
        }

        /* Mobile bottom nav */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            justify-content: space-around;
            padding: 8px 0;
        }

        .mobile-nav a {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.7em;
            padding: 5px;
            cursor: pointer;
        }

        .mobile-nav a .mob-icon {
            font-size: 1.8em;
            margin-bottom: 2px;
        }

        .mobile-nav a.active {
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .main-content {
                padding-bottom: 80px;
            }
        }

        /* Theme toggle button */
        .theme-toggle-btn {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            transition: background 0.3s, border-color 0.3s;
        }

        .theme-toggle-btn:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 107, 0.1);
        }

        .theme-toggle-btn .theme-icon {
            line-height: 1;
            color: currentColor;
        }

        .mobile-theme-toggle {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-theme-toggle {
                display: flex;
                position: fixed;
                right: 16px;
                bottom: 74px;
                z-index: 110;
                background: var(--bg-card);
                box-shadow: 0 4px 14px var(--shadow-color);
            }
        }

        /* Dark mode specific overrides */
        html.dark-mode nav {
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        html.dark-mode .theme-toggle-btn {
            color: var(--accent);
        }

        html.dark-mode .mobile-nav {
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        html.dark-mode input,
        html.dark-mode select,
        html.dark-mode textarea {
            background: var(--bg-input);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        html.dark-mode input::placeholder,
        html.dark-mode textarea::placeholder {
            color: var(--text-tertiary);
        }

        html.dark-mode .swipe-card {
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        html.dark-mode .swipe-card-cuisine {
            background: rgba(30, 42, 71, 0.92);
            color: var(--text-primary);
        }

        html.dark-mode .swipe-btn-nope,
        html.dark-mode .swipe-btn-info,
        html.dark-mode .swipe-btn-superlike {
            background: var(--bg-card);
        }

        html.dark-mode .admin-users-table th {
            color: var(--text-secondary);
        }

        html.dark-mode .fridge-item .item-quantity {
            background: rgba(78, 205, 196, 0.15);
            color: #4ECDC4;
        }

        html.dark-mode .fridge-item .item-category,
        html.dark-mode .scan-item .scan-item-category {
            background: var(--border-color);
            color: var(--text-secondary);
        }

        html.dark-mode .grocery-full-item .item-quantity {
            background: var(--border-light);
            color: var(--text-secondary);
        }

        html.dark-mode .recipe-delete-btn,
        html.dark-mode .emoji-badge {
            background: rgba(30, 42, 71, 0.9);
        }

        html.dark-mode .discover-recipe-image .emoji-badge,
        html.dark-mode .discover-recipe-image .cuisine-badge {
            background: rgba(30, 42, 71, 0.9);
            color: var(--text-primary);
        }

        html.dark-mode .admin-users-table .user-tag {
            background: var(--border-color);
            color: var(--text-secondary);
        }

        html.dark-mode .admin-users-table .password-cell {
            background: rgba(255,255,255,0.05);
        }

        html.dark-mode .scan-loading .spinner {
            border-color: var(--border-color);
            border-top-color: #4ECDC4;
        }

        /* ============================================
           ADMIN PORTAL
           ============================================ */

        .admin-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 14px;
            margin-bottom: 28px;
        }

        .admin-stat-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 18px 14px;
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow-color);
            border: 1px solid var(--border-light);
        }

        .admin-stat-card .a-icon { font-size: 1.6em; margin-bottom: 6px; }
        .admin-stat-card .a-count { font-size: 1.8em; font-weight: 700; color: var(--primary); }
        .admin-stat-card .a-label { font-size: 0.78em; color: var(--text-secondary); margin-top: 2px; }

        .admin-subtab-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .admin-subtab-btn {
            padding: 7px 18px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.88em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-subtab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .admin-table-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .admin-search-input {
            flex: 1;
            min-width: 180px;
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9em;
        }

        .admin-row-badge {
            background: var(--border-light);
            color: var(--text-secondary);
            border-radius: 12px;
            padding: 4px 12px;
            font-size: 0.82em;
            font-weight: 600;
            white-space: nowrap;
        }

        .admin-swipe-filter {
            display: flex;
            gap: 6px;
        }

        .admin-swipe-filter button {
            padding: 5px 12px;
            border-radius: 12px;
            border: 1.5px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 0.82em;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .admin-swipe-filter button.active {
            background: var(--secondary);
            border-color: var(--secondary);
            color: white;
        }

        .admin-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.87em;
            background: var(--bg-card);
        }

        .admin-table th {
            padding: 11px 14px;
            text-align: left;
            background: var(--border-light);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.82em;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .admin-table th:hover { color: var(--primary); }
        .admin-table th.sorted-asc::after { content: ' '; font-size: 0.7em; }
        .admin-table th.sorted-desc::after { content: ' '; font-size: 0.7em; }

        .admin-table td {
            padding: 10px 14px;
            border-top: 1px solid var(--border-light);
            color: var(--text-primary);
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .admin-table tr:hover td { background: var(--bg-card-hover); }

        .admin-promote-btn, .admin-demote-btn {
            padding: 4px 10px;
            border-radius: 6px;
            border: none;
            font-size: 0.8em;
            font-family: inherit;
            cursor: pointer;
            font-weight: 500;
        }

        .admin-promote-btn { background: #4ECDC4; color: white; }
        .admin-demote-btn { background: #FF6B6B; color: white; }
        .admin-promote-btn:hover { background: #3ab5ad; }
        .admin-demote-btn:hover { background: #ee5a5a; }

        .admin-badge-yes { background: rgba(78,205,196,0.15); color: #3ab5ad; border-radius: 6px; padding: 2px 8px; font-size: 0.82em; font-weight: 600; }
        .admin-badge-no { background: var(--border-light); color: var(--text-tertiary); border-radius: 6px; padding: 2px 8px; font-size: 0.82em; }

        .admin-type-liked { background: rgba(255,107,107,0.12); color: #ee5a5a; border-radius: 6px; padding: 2px 8px; font-size: 0.82em; font-weight: 600; }
        .admin-type-disliked { background: rgba(150,150,150,0.12); color: var(--text-secondary); border-radius: 6px; padding: 2px 8px; font-size: 0.82em; font-weight: 600; }

        html.dark-mode .admin-table th { background: var(--border-color); }
        html.dark-mode .admin-stat-card { border-color: var(--border-color); }
        html.dark-mode .admin-table-wrapper { border-color: var(--border-color); }

        /* Construction-themed admin heading */
        .admin-portal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 26px;
            flex-wrap: wrap;
        }

        .admin-hazard-tape {
            display: inline-block;
            background: repeating-linear-gradient(
                -45deg,
                #FFD700 0px,  #FFD700 14px,
                #111111 14px, #111111 28px
            );
            color: #ffffff;
            text-shadow: 0 0 6px #000, 1px 1px 0 #000, -1px -1px 0 #000;
            font-size: 1.55em;
            font-weight: 800;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            padding: 7px 22px 7px 18px;
            border-radius: 6px;
            border: 3px solid #111111;
            line-height: 1.2;
            white-space: nowrap;
        }

        /* High-contrast admin nav link */
        #adminNavLink {
            background: repeating-linear-gradient(
                -45deg,
                #FFD700 0px,  #FFD700 8px,
                #111111 8px, #111111 16px
            ) !important;
            color: #ffffff !important;
            text-shadow: 0 0 4px #000, 1px 1px 0 #000;
            font-weight: 700 !important;
            border: 2px solid #111111;
            letter-spacing: 0.04em;
        }
        #adminNavLink:hover {
            background: repeating-linear-gradient(
                -45deg,
                #ffe033 0px,  #ffe033 8px,
                #222 8px, #222 16px
            ) !important;
            color: #ffffff !important;
        }

        #adminMobileNavLink {
            color: #FFD700 !important;
        }
        #adminMobileNavLink.active {
            color: #FFD700 !important;
        }

        /* DB Dump viewer */
        .db-dump-btn {
            margin-left: auto;
            padding: 7px 16px;
            background: #2d2d2d;
            color: #9cdcfe;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.82em;
            cursor: pointer;
            transition: background 0.2s;
        }
        .db-dump-btn:hover { background: #3a3a3a; }

        .db-dump-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.88);
            z-index: 2000;
            padding: 20px;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
        }
        .db-dump-overlay.active { display: flex; }

        .db-dump-container {
            background: #1e1e1e;
            border-radius: 12px;
            width: 100%;
            max-width: 1100px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            border: 1px solid #3a3a3a;
            overflow: hidden;
        }

        .db-dump-titlebar {
            background: #2d2d2d;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            gap: 14px;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
        }

        .db-dump-titlebar .title-dots {
            display: flex;
            gap: 6px;
        }
        .db-dump-titlebar .title-dots span {
            width: 12px; height: 12px; border-radius: 50%;
        }
        .db-dump-titlebar .title-dots span:nth-child(1) { background: #ff5f57; }
        .db-dump-titlebar .title-dots span:nth-child(2) { background: #ffbd2e; }
        .db-dump-titlebar .title-dots span:nth-child(3) { background: #28ca41; }

        .db-dump-titlebar .title-name {
            flex: 1;
            text-align: center;
            color: #808080;
            font-family: 'Courier New', monospace;
            font-size: 0.82em;
        }

        .db-dump-close {
            background: none;
            border: none;
            color: #808080;
            font-size: 1.1em;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .db-dump-close:hover { background: #3a3a3a; color: #d4d4d4; }

        .db-dump-toolbar {
            background: #252526;
            padding: 8px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
        }

        .db-dump-copy-btn {
            padding: 5px 14px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        .db-dump-copy-btn:hover { background: #1177bb; }

        .db-dump-search {
            padding: 5px 10px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            width: 200px;
        }
        .db-dump-search::placeholder { color: #666; }

        .db-dump-info {
            color: #608b4e;
            font-family: 'Courier New', monospace;
            font-size: 0.78em;
            margin-left: auto;
        }

        .db-dump-pre {
            font-family: 'Courier New', Consolas, 'Lucida Console', monospace;
            font-size: 12.5px;
            line-height: 1.55;
            color: #d4d4d4;
            background: #1e1e1e;
            padding: 20px 24px;
            overflow: auto;
            flex: 1;
            white-space: pre;
            tab-size: 4;
        }

        .db-dump-pre .dump-comment  { color: #6a9955; }
        .db-dump-pre .dump-table    { color: #dcdcaa; font-weight: bold; }
        .db-dump-pre .dump-divider  { color: #555; }
        .db-dump-pre .dump-header   { color: #9cdcfe; }
        .db-dump-pre .dump-number   { color: #b5cea8; }
        .db-dump-pre .dump-string   { color: #ce9178; }
        .db-dump-pre .dump-keyword  { color: #569cd6; }
        .db-dump-pre .dump-null     { color: #569cd6; font-style: italic; }
        .db-dump-pre .dump-highlight { background: #613214; }
    </style>
</head>
<body>
    <nav>
        <a href="tender.html" class="logo">
            <span></span> Tender
        </a>
        <div class="nav-menu">
            <a onclick="switchPage('admin')" data-page="admin" id="adminNavLink" style="display:none;">&#9888; Admin</a>
            <a onclick="switchPage('dashboard')" class="active" data-page="dashboard">Dashboard</a>
            <a onclick="switchPage('swipe')" data-page="swipe">Swipe</a>
            <a onclick="switchPage('discover')" data-page="discover">Discover</a>
            <a onclick="switchPage('mealplan')" data-page="mealplan">Meal Plan</a>
            <a onclick="switchPage('grocery')" data-page="grocery">Grocery List</a>
        </div>
        <div class="user-menu">
            <button class="theme-toggle-btn js-theme-toggle" type="button" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle theme">
                <span class="theme-icon" aria-hidden="true">&#9790;</span>
            </button>
            <div class="user-avatar" id="userAvatar"></div>
            <button class="logout-btn" onclick="logout()">Log Out</button>
        </div>
    </nav>

    <!-- Mobile bottom navigation -->
    <div class="mobile-nav">
        <a onclick="switchPage('dashboard')" class="active" data-page="dashboard">
            <span class="mob-icon"></span> Home
        </a>
        <a onclick="switchPage('swipe')" data-page="swipe">
            <span class="mob-icon"></span> Swipe
        </a>
        <a onclick="switchPage('discover')" data-page="discover">
            <span class="mob-icon"></span> Discover
        </a>
        <a onclick="switchPage('mealplan')" data-page="mealplan">
            <span class="mob-icon"></span> Meal Plan
        </a>
        <a onclick="switchPage('grocery')" data-page="grocery">
            <span class="mob-icon"></span> Grocery
        </a>
        <a onclick="switchPage('admin')" data-page="admin" id="adminMobileNavLink" style="display:none;">
            <span class="mob-icon"></span> Admin
        </a>
    </div>
    <button class="theme-toggle-btn mobile-theme-toggle js-theme-toggle" type="button" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle theme">
        <span class="theme-icon" aria-hidden="true">&#9790;</span>
    </button>

    <main class="main-content">

        <!-- ========== DASHBOARD PAGE ========== -->
        <div id="page-dashboard" class="page-view active">
            <section class="welcome-section">
                <div class="welcome-text">
                    <h1>Welcome back, <span id="userName">Chef</span>!</h1>
                    <p>Ready to discover some delicious recipes today?</p>
                </div>
                <button class="start-swiping-btn" onclick="switchPage('swipe')">Start Swiping </button>
            </section>

            <section class="stats-grid">
                <div class="stat-card">
                    <div class="icon"></div>
                    <h3 id="likedCount">0</h3>
                    <p>Liked Recipes</p>
                </div>
                <div class="stat-card">
                    <div class="icon"></div>
                    <h3 id="groceryCount">0</h3>
                    <p>Grocery Items</p>
                </div>
                <div class="stat-card">
                    <div class="icon"></div>
                    <h3 id="mealPlanCount">0</h3>
                    <p>Meals Planned</p>
                </div>
                <div class="stat-card">
                    <div class="icon"></div>
                    <h3 id="memberDays">0</h3>
                    <p>Days as Member</p>
                </div>
            </section>

            <div class="dashboard-grid">
                <section class="section-card">
                    <div class="section-header">
                        <h2> Liked Recipes</h2>
                        <a onclick="openFavorites()">View All</a>
                    </div>
                    <div class="recipes-grid" id="likedRecipes"></div>
                </section>

                <section class="section-card">
                    <div class="section-header">
                        <h2> Grocery List</h2>
                        <a onclick="switchPage('grocery')">View Full List</a>
                    </div>
                    <div class="grocery-list" id="groceryListPreview"></div>
                    <form class="add-grocery-form" onsubmit="addGroceryItemQuick(event)">
                        <input type="text" id="newGroceryItemQuick" placeholder="Add an item..." required>
                        <button type="submit">Add</button>
                    </form>
                </section>
            </div>

            <section class="section-card profile-section">
                <div class="section-header">
                    <h2> Your Profile <span id="adminBadge" class="admin-badge" style="display:none;">Admin</span></h2>
                    <a onclick="openEditProfileModal()">Edit</a>
                </div>
                <div class="profile-info" id="profileInfo"></div>
                <div class="security-section">
                    <h3>Password &amp; Security</h3>
                    <p>Change your password by confirming your current password first.</p>
                    <form class="security-form" id="changePasswordForm" onsubmit="changePassword(event)">
                        <div class="security-field">
                            <label for="oldPasswordInput">Current Password</label>
                            <input type="password" id="oldPasswordInput" autocomplete="current-password" required>
                        </div>
                        <div class="security-field">
                            <label for="newPasswordInput">New Password</label>
                            <input type="password" id="newPasswordInput" minlength="6" autocomplete="new-password" required>
                        </div>
                        <div class="security-field">
                            <label for="confirmPasswordInput">Confirm New Password</label>
                            <input type="password" id="confirmPasswordInput" minlength="6" autocomplete="new-password" required>
                        </div>
                        <div class="security-actions">
                            <button type="submit" class="btn-save-profile" id="changePasswordBtn">Change Password</button>
                        </div>
                    </form>
                    <div class="security-status" id="passwordChangeStatus"></div>
                </div>
            </section>
        </div>

        <!-- ========== SWIPE PAGE ========== -->
        <div id="page-swipe" class="page-view">
            <div class="swipe-bg" id="swipeBg"></div>
            <div class="emoji-rain-container" id="emojiRainContainer"></div>
            <div class="swipe-page">
                <div class="swipe-difficulty-filters">
                    <span class="swipe-diff-label">Difficulty</span>
                    <button class="swipe-diff-btn active" data-diff="" onclick="setSwipeDifficulty('')">All</button>
                    <button class="swipe-diff-btn" data-diff="easy" onclick="setSwipeDifficulty('easy')">Easy</button>
                    <button class="swipe-diff-btn" data-diff="medium" onclick="setSwipeDifficulty('medium')">Medium</button>
                    <button class="swipe-diff-btn" data-diff="hard" onclick="setSwipeDifficulty('hard')">Hard</button>
                </div>
                <div class="swipe-header">
                    <h1>What's for Dinner?</h1>
                    <p>Swipe right to save, left to skip</p>
                    <div class="swipe-counter" id="swipeCounter">0 recipes liked today</div>
                    <div class="swipe-active-filters" id="swipeActiveFilters"></div>
                </div>

                <div class="swipe-container" id="swipeContainer">
                    <!-- Cards are rendered here by JS -->
                </div>

                <div class="swipe-actions" id="swipeActions">
                    <button class="swipe-action-btn swipe-btn-nope" data-label="Skip" onclick="swipeAction('nope')">
                        
                    </button>
                    <button class="swipe-action-btn swipe-btn-info" data-label="Details" onclick="swipeShowDetails()">
                        
                    </button>
                    <button class="swipe-action-btn swipe-btn-superlike" data-label="Add to Plan" onclick="swipeAddToPlan()">
                        
                    </button>
                    <button class="swipe-action-btn swipe-btn-like" data-label="Like" onclick="swipeAction('like')">
                        
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== DISCOVER PAGE ========== -->
        <div id="page-discover" class="page-view">
            <div class="discover-carousel" id="discoverCarousel" style="display:none;">
                <div class="discover-carousel-track" id="discoverCarouselTrack"></div>
            </div>

            <div class="discover-header">
                <div>
                    <h1>Discover Recipes</h1>
                    <p>Browse and search through all available recipes</p>
                </div>
                <button class="btn-create-recipe" onclick="openCreateRecipeModal()">+ Create Recipe</button>
            </div>

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search recipes by name or ingredient..." oninput="filterRecipes()">
                <select id="cuisineFilter" onchange="filterRecipes()">
                    <option value="">All Cuisines</option>
                </select>
                <select id="difficultyFilter" onchange="filterRecipes()">
                    <option value="">All Difficulties</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>

            <div class="dietary-filter-section" id="dietaryFilterSection">
                <span class="dietary-filter-label">Dietary:</span>
                <div class="dietary-filter-chips" id="dietaryFilterChips"></div>
            </div>

            <div class="filter-chips" id="cuisineChips"></div>

            <div class="discover-grid" id="discoverGrid"></div>
        </div>

        <!-- ========== MEAL PLAN PAGE ========== -->
        <div id="page-mealplan" class="page-view">
            <div class="mealplan-header">
                <h1>Meal Plan</h1>
                <div class="mealplan-nav">
                    <button onclick="changeWeek(-1)"> Prev</button>
                    <span class="week-label" id="weekLabel"></span>
                    <button onclick="changeWeek(1)">Next </button>
                </div>
            </div>

            <div class="mealplan-weeks-container" id="mealplanWeek"></div>

            <div class="ingredient-action-bar" id="ingredientBar">
                <div class="ingredient-bar-info">
                    <span class="bar-title" id="ingredientBarTitle">0 days selected</span>
                    <span class="bar-subtitle" id="ingredientBarSubtitle">0 meals  0 ingredients</span>
                </div>
                <div class="ingredient-bar-actions">
                    <button class="btn-clear-selection" onclick="clearDaySelection()">Clear</button>
                    <button class="btn-add-ingredients" onclick="addSelectedIngredientsToGrocery()"> Add All Ingredients</button>
                </div>
            </div>

            <div class="mealplan-summary">
                <h2> Week Summary</h2>
                <div id="mealplanSummary">
                    <div class="summary-stat">
                        <span class="label">Meals Planned</span>
                        <span class="value" id="summaryMeals">0</span>
                    </div>
                    <div class="summary-stat">
                        <span class="label">Unique Recipes</span>
                        <span class="value" id="summaryRecipes">0</span>
                    </div>
                    <div class="summary-stat">
                        <span class="label">Total Cook Time</span>
                        <span class="value" id="summaryCookTime">0 min</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== GROCERY & FRIDGE PAGE ========== -->
        <div id="page-grocery" class="page-view">
            <div class="grocery-page-header">
                <h1 id="groceryPageTitle">Grocery List</h1>
                <div class="grocery-header-actions">
                    <button class="btn-clear-all" id="btnClearSection" onclick="clearCurrentSection()">Clear All</button>
                </div>
            </div>

            <!-- Tab Switcher -->
            <div class="grocery-tabs">
                <button class="grocery-tab-btn active" onclick="switchGroceryTab('grocery')" id="tabGrocery">Grocery List</button>
                <button class="grocery-tab-btn" onclick="switchGroceryTab('fridge')" id="tabFridge">My Fridge</button>
            </div>

            <!-- GROCERY TAB -->
            <div class="grocery-tab-content active" id="groceryTabContent">
                <div class="grocery-stats" id="groceryPageStats">
                    <div class="grocery-stat-card">
                        <h3 id="groceryTotalItems">0</h3>
                        <p>Total Items</p>
                    </div>
                    <div class="grocery-stat-card">
                        <h3 id="groceryCheckedItems">0</h3>
                        <p>Checked Off</p>
                    </div>
                    <div class="grocery-stat-card">
                        <h3 id="groceryRemainingItems">0</h3>
                        <p>Remaining</p>
                    </div>
                </div>

                <form class="grocery-page-form" onsubmit="addGroceryItemFull(event)">
                    <input type="text" id="newGroceryName" placeholder="Item name..." required>
                    <input type="number" id="newGroceryQty" placeholder="Qty" min="1" value="1">
                    <button type="submit">Add Item</button>
                </form>

                <div class="grocery-full-list" id="groceryFullList"></div>
            </div>

            <!-- FRIDGE TAB -->
            <div class="grocery-tab-content" id="fridgeTabContent">
                <div class="grocery-stats">
                    <div class="grocery-stat-card">
                        <h3 id="fridgeTotalItems">0</h3>
                        <p>Items in Fridge</p>
                    </div>
                </div>

                <div class="fridge-actions">
                    <form onsubmit="addFridgeItemManual(event)">
                        <input type="text" id="newFridgeName" placeholder="Ingredient name..." required>
                        <input type="number" id="newFridgeQty" placeholder="Qty" min="1" value="1">
                        <button type="submit">Add</button>
                    </form>
                    <button class="btn-scan-fridge" onclick="triggerFridgeScan()">
                        <span>Scan Fridge</span>
                    </button>
                    <input type="file" id="fridgeImageInput" accept="image/*" capture="environment" style="display:none" onchange="handleFridgeImage(event)">
                </div>

                <div class="grocery-full-list" id="fridgeFullList"></div>
            </div>
        </div>

        <!-- ========== ADMIN PAGE ========== -->
        <div id="page-admin" class="page-view">
            <div class="admin-portal-header">
                <span class="admin-hazard-tape">&#9888; Admin Portal</span>
                <button class="db-dump-btn" onclick="openDbDump()">&#x1F4C4; View Raw DB</button>
            </div>

            <!-- Overview Stats -->
            <div class="admin-overview-grid" id="adminOverviewGrid">
                <div class="admin-stat-card"><div class="a-icon"></div><div class="a-count" id="aStatUsers">-</div><div class="a-label">Users</div></div>
                <div class="admin-stat-card"><div class="a-icon"></div><div class="a-count" id="aStatRecipes">-</div><div class="a-label">Recipes</div></div>
                <div class="admin-stat-card"><div class="a-icon"></div><div class="a-count" id="aStatLikes">-</div><div class="a-label">Likes</div></div>
                <div class="admin-stat-card"><div class="a-icon"></div><div class="a-count" id="aStatDislikes">-</div><div class="a-label">Dislikes</div></div>
                <div class="admin-stat-card"><div class="a-icon"></div><div class="a-count" id="aStatGrocery">-</div><div class="a-label">Grocery Items</div></div>
                <div class="admin-stat-card"><div class="a-icon"></div><div class="a-count" id="aStatFridge">-</div><div class="a-label">Fridge Items</div></div>
                <div class="admin-stat-card"><div class="a-icon"></div><div class="a-count" id="aStatMealPlans">-</div><div class="a-label">Meal Plans</div></div>
                <div class="admin-stat-card"><div class="a-icon"></div><div class="a-count" id="aStatDbSize" style="font-size:1.1em;">-</div><div class="a-label">DB Size</div></div>
            </div>

            <!-- Sub-tab bar -->
            <div class="admin-subtab-bar">
                <button class="admin-subtab-btn active" onclick="switchAdminTab('users')" data-tab="users">Users</button>
                <button class="admin-subtab-btn" onclick="switchAdminTab('recipes')" data-tab="recipes">Recipes</button>
                <button class="admin-subtab-btn" onclick="switchAdminTab('swipes')" data-tab="swipes">Swipes</button>
                <button class="admin-subtab-btn" onclick="switchAdminTab('grocery')" data-tab="grocery">Grocery</button>
                <button class="admin-subtab-btn" onclick="switchAdminTab('fridge')" data-tab="fridge">Fridge</button>
                <button class="admin-subtab-btn" onclick="switchAdminTab('mealplans')" data-tab="mealplans">Meal Plans</button>
            </div>

            <!-- Toolbar -->
            <div class="admin-table-toolbar">
                <input type="text" class="admin-search-input" id="adminSearchInput" placeholder="Search..." oninput="adminSearch(this.value)">
                <span class="admin-row-badge" id="adminRowBadge">0 rows</span>
                <div class="admin-swipe-filter" id="adminSwipeFilter" style="display:none;">
                    <button class="active" onclick="adminSwipeFilterSet('all', this)">All</button>
                    <button onclick="adminSwipeFilterSet('liked', this)">Liked</button>
                    <button onclick="adminSwipeFilterSet('disliked', this)">Disliked</button>
                </div>
            </div>

            <!-- Table area -->
            <div class="admin-table-wrapper">
                <table class="admin-table" id="adminDataTable">
                    <thead id="adminTableHead"></thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Favorites Fullscreen View -->
    <div class="favorites-overlay" id="favoritesOverlay">
        <div class="favorites-container">
            <div class="favorites-header">
                <div>
                    <h1> My Favorites</h1>
                    <p id="favoritesCount"></p>
                </div>
                <button class="favorites-back-btn" onclick="closeFavorites()"> Back</button>
            </div>
            <div class="favorites-grid" id="favoritesGrid"></div>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div class="modal-overlay" id="confirmDialog">
        <div class="modal" style="max-width: 420px; text-align: center; padding: 35px 30px;">
            <div id="confirmIcon" style="font-size: 3em; margin-bottom: 12px;"></div>
            <h2 id="confirmTitle" style="font-size: 1.3em; margin-bottom: 10px;"></h2>
            <p id="confirmMessage" style="color: #666; font-size: 1em; margin-bottom: 28px;"></p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="confirmCancel" style="padding: 12px 28px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; font-family: inherit; font-weight: 600; font-size: 1em; cursor: pointer;">Cancel</button>
                <button id="confirmOk" style="padding: 12px 28px; border: none; border-radius: 12px; background: var(--gradient); color: white; font-family: inherit; font-weight: 600; font-size: 1em; cursor: pointer;"></button>
            </div>
        </div>
    </div>

    <!-- Recipe Detail Modal -->
    <div class="modal-overlay" id="recipeModal">
        <div class="modal" style="position:relative;">
            <button class="modal-close" onclick="closeRecipeModal()"></button>
            <div class="modal-header" id="modalHeader">
                <span class="emoji" id="modalEmoji"></span>
                <div class="header-content">
                    <div class="header-text">
                        <h2 id="modalTitle"></h2>
                        <p id="modalMeta"></p>
                    </div>
                    <a id="modalSourceLink" class="modal-source-link" style="display:none;" target="_blank" rel="noopener noreferrer">Original Recipe Link</a>
                </div>
            </div>
            <div id="modalImageBanner" style="display:none; width:100%; margin:14px 0 10px; border-radius:12px; overflow:hidden; background:#111;">
                <img id="modalBannerImg" style="display:block; width:100%; height:auto; max-height:52vh; object-fit:contain;">
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>

    <!-- Add Meal Modal -->
    <div class="modal-overlay add-meal-modal" id="addMealModal">
        <div class="modal" style="position:relative;">
            <button class="modal-close" onclick="closeAddMealModal()"></button>
            <div class="modal-header">
                <span class="emoji"></span>
                <div>
                    <h2 id="addMealTitle">Select a Recipe</h2>
                    <p>Pick a recipe to add to your meal plan</p>
                </div>
            </div>
            <div class="modal-body">
                <div class="add-meal-search-wrap">
                    <input class="add-meal-search" id="addMealSearch" type="text" placeholder="Search by name, cuisine, or ingredient..." oninput="onAddMealSearch(this.value)" autocomplete="off">
                    <button class="add-meal-search-clear" id="addMealSearchClear" onclick="clearAddMealSearch()" type="button"></button>
                </div>
                <div class="add-meal-filter-row">
                    <button type="button" class="add-meal-filter-btn" id="addMealFilterLiked" onclick="setAddMealRecipeFilter('liked')"> Favorites</button>
                    <button type="button" class="add-meal-filter-btn active" id="addMealFilterAll" onclick="setAddMealRecipeFilter('all')"> All Recipes</button>
                </div>
                <div class="recipe-select-list" id="recipeSelectList"></div>
            </div>
        </div>
    </div>

    <!-- Schedule Recipe Modal (from swipe page) -->
    <div class="modal-overlay" id="scheduleRecipeModal">
        <div class="modal" style="position:relative; max-width:480px;">
            <button class="modal-close" onclick="closeScheduleModal()"></button>
            <div class="modal-header">
                <span class="emoji" id="scheduleRecipeEmoji"></span>
                <div>
                    <h2 id="scheduleRecipeName">Recipe</h2>
                    <p>When do you want to eat this?</p>
                </div>
            </div>
            <div class="modal-body">
                <div class="schedule-picker">
                    <label class="schedule-label">Pick a day</label>
                    <div class="schedule-days" id="scheduleDays"></div>

                    <div class="schedule-day-preview" id="scheduleDayPreview"></div>

                    <label class="schedule-label" style="margin-top:18px;">Pick a meal</label>
                    <div class="schedule-meals" id="scheduleMeals"></div>
                </div>
            </div>
            <div class="edit-profile-actions">
                <button class="btn-cancel-profile" onclick="closeScheduleModal()">Cancel</button>
                <button class="btn-save-profile" onclick="confirmScheduleRecipe()">Add to Plan</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="editProfileModal">
        <div class="modal" style="position:relative; max-width:550px;">
            <button class="modal-close" onclick="closeEditProfileModal()"></button>
            <div class="modal-header">
                <span class="emoji"></span>
                <div>
                    <h2>Edit Profile</h2>
                    <p>Update your personal information</p>
                </div>
            </div>
            <div class="modal-body">
                <form class="edit-profile-form" id="editProfileForm" onsubmit="saveProfile(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFirstName">First Name</label>
                            <input type="text" id="editFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="editLastName">Last Name</label>
                            <input type="text" id="editLastName" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editCookingSkill">Cooking Skill</label>
                        <select id="editCookingSkill">
                            <option value="beginner">Beginner - Just learning the basics</option>
                            <option value="intermediate">Intermediate - Comfortable in the kitchen</option>
                            <option value="advanced">Advanced - I love a challenge</option>
                            <option value="pro">Pro Chef - Culinary expert</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editHouseholdSize">Household Size</label>
                            <select id="editHouseholdSize">
                                <option value="1">Just me</option>
                                <option value="2">2 people</option>
                                <option value="3-4">3-4 people</option>
                                <option value="5+">5+ people</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editWeeklyBudget">Weekly Budget</label>
                            <select id="editWeeklyBudget">
                                <option value="budget">Budget-friendly (Under $50)</option>
                                <option value="moderate">Moderate ($50-$100)</option>
                                <option value="flexible">Flexible ($100-$150)</option>
                                <option value="premium">Premium ($150+)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editMealsPerWeek">Meals Per Week</label>
                        <select id="editMealsPerWeek">
                            <option value="1-3">1-3 meals</option>
                            <option value="4-7">4-7 meals</option>
                            <option value="8-14">8-14 meals</option>
                            <option value="15+">15+ meals</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Dietary Restrictions</label>
                        <div class="checkbox-group" id="editDietary">
                            <label><input type="checkbox" value="vegetarian"> Vegetarian</label>
                            <label><input type="checkbox" value="vegan"> Vegan</label>
                            <label><input type="checkbox" value="gluten-free"> Gluten-Free</label>
                            <label><input type="checkbox" value="dairy-free"> Dairy-Free</label>
                            <label><input type="checkbox" value="keto"> Keto</label>
                            <label><input type="checkbox" value="halal"> Halal</label>
                            <label><input type="checkbox" value="kosher"> Kosher</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Favorite Cuisines</label>
                        <div class="checkbox-group" id="editCuisines">
                            <label><input type="checkbox" value="italian"> Italian</label>
                            <label><input type="checkbox" value="mexican"> Mexican</label>
                            <label><input type="checkbox" value="chinese"> Chinese</label>
                            <label><input type="checkbox" value="japanese"> Japanese</label>
                            <label><input type="checkbox" value="indian"> Indian</label>
                            <label><input type="checkbox" value="thai"> Thai</label>
                            <label><input type="checkbox" value="mediterranean"> Mediterranean</label>
                            <label><input type="checkbox" value="american"> American</label>
                            <label><input type="checkbox" value="french"> French</label>
                            <label><input type="checkbox" value="korean"> Korean</label>
                            <label><input type="checkbox" value="greek"> Greek</label>
                            <label><input type="checkbox" value="vietnamese"> Vietnamese</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="edit-profile-actions">
                <button class="btn-cancel-profile" onclick="closeEditProfileModal()">Cancel</button>
                <button class="btn-save-profile" id="saveProfileBtn" onclick="saveProfile(event)">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Create Recipe Modal -->
    <div class="modal-overlay" id="createRecipeModal">
        <div class="modal" style="position:relative; max-width:720px;">
            <button class="modal-close" onclick="closeCreateRecipeModal()"></button>
            <div class="modal-header">
                <span class="emoji"></span>
                <div>
                    <h2>Create Recipe</h2>
                    <p>Share your own recipe with Tender</p>
                </div>
            </div>
            <div class="modal-body">
                <form class="edit-profile-form" id="createRecipeForm" onsubmit="submitNewRecipe(event)">
                    <div class="form-group">
                        <label for="newRecipeName">Recipe Name *</label>
                        <input type="text" id="newRecipeName" required placeholder="e.g. Grandma's Lasagna">
                    </div>

                    <div class="form-group">
                        <label for="newRecipeDescription">Description</label>
                        <input type="text" id="newRecipeDescription" placeholder="A short description of your recipe">
                    </div>

                    <div class="form-group">
                        <label for="newRecipeSourceLink">Original Recipe URL (optional)</label>
                        <input type="url" id="newRecipeSourceLink" placeholder="https://example.com/recipe">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="newRecipeEmoji">Emoji</label>
                            <input type="text" id="newRecipeEmoji" placeholder="e.g.    " maxlength="4">
                        </div>
                        <div class="form-group" style="flex:2;">
                            <label>Recipe Image (optional)</label>
                            <div class="image-upload-area" id="newRecipeImageArea" onclick="document.getElementById('newRecipeImageInput').click()">
                                <div class="upload-placeholder"><span></span>Click to upload an image</div>
                                <input type="file" id="newRecipeImageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(this, 'newRecipeImageArea', 'newRecipeImageData')">
                                <input type="hidden" id="newRecipeImageData">
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="newRecipeCookTime">Cook Time (minutes)</label>
                            <input type="number" id="newRecipeCookTime" min="1" placeholder="30">
                        </div>
                        <div class="form-group">
                            <label for="newRecipeServings">Servings</label>
                            <input type="number" id="newRecipeServings" min="1" placeholder="4">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="newRecipeDifficulty">Difficulty</label>
                            <select id="newRecipeDifficulty">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newRecipeCuisine">Cuisine</label>
                            <select id="newRecipeCuisine">
                                <option value="">Select...</option>
                                <option value="italian">Italian</option>
                                <option value="mexican">Mexican</option>
                                <option value="chinese">Chinese</option>
                                <option value="japanese">Japanese</option>
                                <option value="indian">Indian</option>
                                <option value="thai">Thai</option>
                                <option value="mediterranean">Mediterranean</option>
                                <option value="american">American</option>
                                <option value="french">French</option>
                                <option value="korean">Korean</option>
                                <option value="greek">Greek</option>
                                <option value="vietnamese">Vietnamese</option>
                                <option value="british">British</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newRecipeIngredients">Ingredients (one per line)</label>
                        <textarea id="newRecipeIngredients" rows="5" placeholder="1 lb pasta&#10;2 cups tomato sauce&#10;1 cup mozzarella"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="newRecipeInstructions">Instructions</label>
                        <textarea id="newRecipeInstructions" rows="4" placeholder="Step-by-step instructions..."></textarea>
                    </div>
                </form>
            </div>
            <div class="edit-profile-actions">
                <button class="btn-cancel-profile" onclick="closeCreateRecipeModal()">Cancel</button>
                <button class="btn-save-profile" id="submitRecipeBtn" onclick="submitNewRecipe(event)">Create Recipe</button>
            </div>
        </div>
    </div>

    <!-- Edit Recipe Modal -->
    <div class="modal-overlay" id="editRecipeModal">
        <div class="modal" style="position:relative; max-width:720px;">
            <button class="modal-close" onclick="closeEditRecipeModal()"></button>
            <div class="modal-header">
                <span class="emoji"></span>
                <div>
                    <h2>Edit Recipe</h2>
                    <p>Update this recipe's details</p>
                </div>
            </div>
            <div class="modal-body">
                <form class="edit-profile-form" id="editRecipeForm">
                    <input type="hidden" id="editRecipeId">
                    <div class="form-group">
                        <label for="editRecipeName">Recipe Name *</label>
                        <input type="text" id="editRecipeName" required>
                    </div>
                    <div class="form-group">
                        <label for="editRecipeDescription">Description</label>
                        <input type="text" id="editRecipeDescription">
                    </div>
                    <div class="form-group">
                        <label for="editRecipeSourceLink">Original Recipe URL (optional)</label>
                        <input type="url" id="editRecipeSourceLink" placeholder="https://example.com/recipe">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRecipeEmoji">Emoji</label>
                            <input type="text" id="editRecipeEmoji" maxlength="4">
                        </div>
                        <div class="form-group" style="flex:2;">
                            <label>Recipe Image (optional)</label>
                            <div class="image-upload-area" id="editRecipeImageArea" onclick="document.getElementById('editRecipeImageInput').click()">
                                <div class="upload-placeholder"><span></span>Click to upload an image</div>
                                <input type="file" id="editRecipeImageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(this, 'editRecipeImageArea', 'editRecipeImageData')">
                                <input type="hidden" id="editRecipeImageData">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRecipeCookTime">Cook Time (minutes)</label>
                            <input type="number" id="editRecipeCookTime" min="1">
                        </div>
                        <div class="form-group">
                            <label for="editRecipeServings">Servings</label>
                            <input type="number" id="editRecipeServings" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRecipeDifficulty">Difficulty</label>
                            <select id="editRecipeDifficulty">
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editRecipeCuisine">Cuisine</label>
                            <select id="editRecipeCuisine">
                                <option value="">Select...</option>
                                <option value="italian">Italian</option>
                                <option value="mexican">Mexican</option>
                                <option value="chinese">Chinese</option>
                                <option value="japanese">Japanese</option>
                                <option value="indian">Indian</option>
                                <option value="thai">Thai</option>
                                <option value="mediterranean">Mediterranean</option>
                                <option value="american">American</option>
                                <option value="french">French</option>
                                <option value="korean">Korean</option>
                                <option value="greek">Greek</option>
                                <option value="vietnamese">Vietnamese</option>
                                <option value="british">British</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editRecipeIngredients">Ingredients (one per line)</label>
                        <textarea id="editRecipeIngredients" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editRecipeInstructions">Instructions</label>
                        <textarea id="editRecipeInstructions" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="edit-profile-actions">
                <button class="btn-cancel-profile" onclick="closeEditRecipeModal()">Cancel</button>
                <button class="btn-save-profile" id="saveRecipeBtn" onclick="submitEditRecipe(event)">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Fridge Scan Results Modal -->
    <div class="scan-overlay" id="scanModal">
        <div class="scan-modal">
            <div class="scan-modal-header">
                <h2>Scan Results</h2>
                <p>We found these ingredients. Uncheck any you don't want to add.</p>
            </div>
            <div class="scan-modal-body" id="scanModalBody">
                <!-- Populated by JS -->
            </div>
            <div class="scan-modal-footer">
                <button class="btn-scan-cancel" onclick="closeScanModal()">Cancel</button>
                <button class="btn-scan-confirm" onclick="confirmScanResults()">Add to Fridge</button>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        // ==================== AUTH CHECK ====================
        if (!TenderAPI.isLoggedIn()) {
            window.location.replace('login.html');
            throw new Error('Not logged in, redirecting.');
        }

        // ==================== STATE ====================
        let currentUser = null;
        let isAdmin = false;
        let allRecipes = [];
        let likedRecipeIds = new Set();
        let myRecipeIds = new Set();
        let currentWeekStart = getMonday(new Date());
        let mealPlanData = [];
        let pendingMealSlot = null; // { date, mealType, course }
        let addMealFilterMode = 'all'; // 'liked' | 'all'
        let addMealLikedRecipes = [];
        let addMealSearchQuery = '';
        let groceryDay = localStorage.getItem('tenderGroceryDay') || null;
        let mealPlanDragBound = false;
        let mealPlanDragState = {
            active: false,
            sourceDate: null,
            sourceMealType: null,
            sourceEl: null,
            dropEl: null,
            ghostEl: null,
            moving: false
        };
        let mealPlanLastMovedTarget = null;

        // ==================== THEME ====================
        function updateThemeToggleUI() {
            const isDarkMode = document.documentElement.classList.contains('dark-mode');
            document.querySelectorAll('.js-theme-toggle .theme-icon').forEach(icon => {
                icon.innerHTML = isDarkMode ? '&#9728;' : '&#9790;';
            });
            document.querySelectorAll('.js-theme-toggle').forEach(btn => {
                btn.setAttribute('aria-label', isDarkMode ? 'Switch to light mode' : 'Switch to dark mode');
                btn.setAttribute('title', isDarkMode ? 'Switch to light mode' : 'Switch to dark mode');
            });
        }

        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark-mode');
            const isDarkMode = html.classList.contains('dark-mode');
            localStorage.setItem('tender_theme', isDarkMode ? 'dark' : 'light');
            updateThemeToggleUI();
        }

        // ==================== DIETARY FILTERING ====================
        const DIETARY_EXCLUSIONS = {
            'gluten-free': ['flour', 'bread', 'pasta', 'spaghetti', 'macaroni', 'panko', 'breadcrumbs',
                'tortillas', 'tortilla', 'tostada shells', 'ramen noodles', 'phyllo', 'puff pastry',
                'wontons', 'gnocchi', 'rolls', 'buns', 'noodles'],
            'dairy-free': ['cheese', 'milk', 'cream', 'butter', 'yogurt', 'cheddar', 'mozzarella',
                'parmesan', 'pecorino', 'gruyere', 'feta', 'paneer', 'ghee', 'bechamel'],
            'vegetarian': ['chicken', 'beef', 'pork', 'shrimp', 'fish sauce', 'clams', 'duck',
                'sausage', 'bacon', 'spam', 'ground beef', 'pork shoulder', 'pork belly',
                'steak', 'sausage meat', 'chicken breast', 'chicken thighs', 'duck legs', 'duck fat'],
            'vegan': ['chicken', 'beef', 'pork', 'shrimp', 'fish sauce', 'clams', 'duck',
                'sausage', 'bacon', 'spam', 'ground beef', 'pork shoulder', 'pork belly',
                'steak', 'sausage meat', 'chicken breast', 'chicken thighs', 'duck legs', 'duck fat',
                'egg', 'egg wash', 'cheese', 'milk', 'cream', 'butter', 'yogurt', 'cheddar',
                'mozzarella', 'parmesan', 'pecorino', 'gruyere', 'feta', 'paneer', 'ghee',
                'bechamel', 'honey', 'dashi'],
            'keto': ['pasta', 'spaghetti', 'macaroni', 'rice', 'basmati rice', 'cooked rice',
                'bread', 'potatoes', 'flour', 'sugar', 'tortillas', 'tortilla', 'tostada shells',
                'ramen noodles', 'gnocchi', 'grits', 'rolls', 'buns', 'beans', 'refried beans',
                'noodles'],
            'halal': ['pork', 'bacon', 'spam', 'pork shoulder', 'pork belly', 'sausage meat',
                'red wine', 'wine', 'mirin'],
            'kosher': ['pork', 'bacon', 'spam', 'pork shoulder', 'pork belly', 'sausage meat',
                'shrimp', 'clams']
        };

        const ALL_DIETARY_OPTIONS = [
            { key: 'vegetarian', label: 'Vegetarian' },
            { key: 'vegan', label: 'Vegan' },
            { key: 'gluten-free', label: 'Gluten-Free' },
            { key: 'dairy-free', label: 'Dairy-Free' },
            { key: 'keto', label: 'Keto' },
            { key: 'halal', label: 'Halal' },
            { key: 'kosher', label: 'Kosher' }
        ];

        // Active dietary filters for the discover page (toggleable by user)
        let discoverDietaryFilters = new Set();

        function canManageRecipe(recipeId) {
            return isAdmin || myRecipeIds.has(String(recipeId));
        }

        function filterByDietary(recipes, restrictions) {
            // If restrictions passed explicitly, use those; otherwise use user profile
            const active = restrictions
                || (currentUser && Array.isArray(currentUser.dietary) ? currentUser.dietary : []);
            if (active.length === 0) return recipes;

            return recipes.filter(recipe => {
                const overrides = Array.isArray(recipe.dietaryOverrides) ? recipe.dietaryOverrides : [];
                const ingredients = Array.isArray(recipe.ingredients)
                    ? recipe.ingredients.map(i => i.toLowerCase())
                    : (recipe.ingredients || '').toLowerCase().split(',').map(i => i.trim());

                for (const restriction of active) {
                    // Explicit denial: admin confirmed this recipe contains this allergen
                    if (overrides.includes('!' + restriction)) return false;
                    // Explicit approval: admin confirmed this recipe is safe
                    if (overrides.includes(restriction)) continue;

                    const excluded = DIETARY_EXCLUSIONS[restriction] || [];
                    for (const ing of ingredients) {
                        for (const excl of excluded) {
                            if (ing.includes(excl)) return false;
                        }
                    }
                }
                return true;
            });
        }

        // Returns: 'denied' | 'confirmed' | 'natural' | 'none'
        // denied   = has !gluten-free override  explicitly NOT GF
        // confirmed= has gluten-free override   explicitly GF
        // natural  = passes ingredient check, no override
        // none     = fails ingredient check, no override
        function computeRecipeGFState(recipe) {
            const overrides = Array.isArray(recipe.dietaryOverrides) ? recipe.dietaryOverrides : [];
            if (overrides.includes('!gluten-free')) return 'denied';
            if (overrides.includes('gluten-free'))  return 'confirmed';
            const excluded = DIETARY_EXCLUSIONS['gluten-free'] || [];
            const ings = Array.isArray(recipe.ingredients)
                ? recipe.ingredients.map(i => i.toLowerCase())
                : (recipe.ingredients || '').toLowerCase().split(',').map(i => i.trim());
            return ings.some(ing => excluded.some(excl => ing.includes(excl))) ? 'none' : 'natural';
        }

        // Render active dietary tags on the swipe page header
        function renderSwipeDietaryTags() {
            const container = document.getElementById('swipeActiveFilters');
            if (!container) return;
            const userDietary = currentUser && Array.isArray(currentUser.dietary) ? currentUser.dietary : [];
            if (userDietary.length === 0) {
                container.innerHTML = '<span class="swipe-no-filters">No dietary filters active</span>';
                return;
            }
            container.innerHTML = userDietary.map(d =>
                `<span class="swipe-filter-tag">${escapeHtml(d)}</span>`
            ).join('');
        }

        function setSwipeDifficulty(diff) {
            swipeDifficultyFilter = diff;
            document.querySelectorAll('.swipe-diff-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.diff === diff);
            });
            applySwipeFilters();
        }

        function applySwipeFilters() {
            let filtered = swipeDeckMaster.slice();
            if (swipeDifficultyFilter) {
                filtered = filtered.filter(r => (r.difficulty || 'medium') === swipeDifficultyFilter);
            }
            swipeDeck = shuffleArray(filtered);
            renderSwipeCard();
        }

        // Build the dietary filter chips for the discover page
        function renderDiscoverDietaryChips() {
            const container = document.getElementById('dietaryFilterChips');
            if (!container) return;
            container.innerHTML = ALL_DIETARY_OPTIONS.map(opt => {
                const isActive = discoverDietaryFilters.has(opt.key);
                return `<button class="dietary-chip${isActive ? ' active' : ''}" data-dietary="${opt.key}" onclick="toggleDiscoverDietary(this, '${opt.key}')">${opt.label}</button>`;
            }).join('');
        }

        function toggleDiscoverDietary(chip, key) {
            if (discoverDietaryFilters.has(key)) {
                discoverDietaryFilters.delete(key);
                chip.classList.remove('active');
            } else {
                discoverDietaryFilters.add(key);
                chip.classList.add('active');
            }
            filterRecipes();
        }

        // ==================== PAGE NAVIGATION ====================
        function switchPage(page) {
            const wasOnSwipe = document.getElementById('page-swipe').classList.contains('active');

            if (wasOnSwipe && page !== 'swipe') {
                stopEmojiRain(true);
                setSwipeBackground(0);
            }

            // Hide all pages
            document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
            // Show target
            document.getElementById('page-' + page).classList.add('active');

            // Update nav active states
            document.querySelectorAll('.nav-menu a, .mobile-nav a').forEach(a => {
                a.classList.toggle('active', a.dataset.page === page);
            });

            // Load data for the page
            if (page === 'swipe') loadSwipePage();
            if (page === 'discover') loadDiscoverPage();
            if (page === 'mealplan') loadMealPlanPage();
            if (page === 'grocery') { loadGroceryPage(); loadFridgePage(); }
            if (page === 'admin') loadAdminPage();
        }

        // ==================== DASHBOARD ====================
        async function loadDashboard() {
            // Step 1: Load current user
            try {
                currentUser = await TenderAPI.getCurrentUser();
                if (!currentUser || !currentUser.firstName) {
                    throw new Error('Invalid user data received');
                }
                TenderDB.setCurrentUser(currentUser);
            } catch (err) {
                console.error('Failed to load user:', err);
                localStorage.removeItem('tender_token');
                localStorage.removeItem('tender_user_cache');
                localStorage.removeItem('tender_current_user');
                window.location.replace('login.html');
                return;
            }

            // Step 2: Set user name, avatar, and admin status
            document.getElementById('userName').textContent = currentUser.firstName;
            document.getElementById('userAvatar').textContent = currentUser.firstName.charAt(0).toUpperCase();
            isAdmin = currentUser.isAdmin === true;
            if (isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.getElementById('adminNavLink').style.display = '';
                document.getElementById('adminMobileNavLink').style.display = '';
            } else {
                document.getElementById('adminBadge').style.display = 'none';
            }

            // Load user's own recipes so edit/delete permissions work outside Discover too
            try {
                const myRecipes = await TenderAPI.getMyRecipes();
                myRecipeIds = new Set((myRecipes || []).map(r => String(r.id)));
            } catch (err) {
                console.error('Failed to load user recipes for permissions:', err);
                myRecipeIds = new Set();
            }

            // Step 3: Load stats - use multiple sources for resilience
            try {
                const stats = await TenderAPI.getStats();
                document.getElementById('likedCount').textContent = stats.likedCount || 0;
                document.getElementById('groceryCount').textContent = stats.groceryCount || 0;
                document.getElementById('mealPlanCount').textContent = stats.mealPlanCount || 0;
                document.getElementById('memberDays').textContent = stats.memberDays || 1;
            } catch (err) {
                console.error('Failed to load stats from API, computing from data:', err);
                // Fallback: compute stats directly from individual API calls
                try {
                    const [liked, grocery, mealplan] = await Promise.all([
                        TenderAPI.getLikedRecipes().catch(() => []),
                        TenderAPI.getGroceryList().catch(() => []),
                        TenderAPI.getMealPlan().catch(() => [])
                    ]);
                    document.getElementById('likedCount').textContent = liked.length;
                    document.getElementById('groceryCount').textContent = grocery.length;
                    document.getElementById('mealPlanCount').textContent = mealplan.length;
                    // Member days from user createdAt
                    const created = new Date(currentUser.createdAt);
                    const days = isNaN(created) ? 1 : Math.floor((Date.now() - created) / 86400000) + 1;
                    document.getElementById('memberDays').textContent = days;
                } catch (fallbackErr) {
                    console.error('Fallback stats also failed:', fallbackErr);
                }
            }

            // Step 4: Load liked recipes preview
            await loadLikedRecipesPreview();

            // Step 5: Load grocery preview
            await loadGroceryPreview();

            // Step 6: Load profile info
            loadProfileInfo(currentUser);
        }

        async function loadLikedRecipesPreview() {
            const container = document.getElementById('likedRecipes');
            try {
                const likedRecipes = await TenderAPI.getLikedRecipes();
                likedRecipeIds = new Set(likedRecipes.map(r => r.id));

                if (likedRecipes.length === 0) {
                    const recipes = await TenderAPI.getRecipes();
                    const samples = recipes.slice(0, 4);
                    container.innerHTML = samples.map(recipe => `
                        <div class="recipe-card" onclick="switchPage('discover')">
                            <div class="recipe-image${recipe.image ? ' has-img' : ''}" style="position:relative;">
                                ${recipe.image
                                    ? `<img src="${recipe.image}" alt="" style="width:100%;height:100%;object-fit:cover;">`
                                    : (recipe.emoji || '')}
                            </div>
                            <div class="recipe-info">
                                <h4>${recipe.name}</h4>
                                <p>${recipe.cookTime} min</p>
                            </div>
                        </div>
                    `).join('') + `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 15px; color: #888; font-size: 0.9em;">
                            Start swiping to add your favorite recipes!
                        </div>
                    `;
                    return;
                }

                container.innerHTML = likedRecipes.slice(0, 6).map(recipe => `
                    <div class="recipe-card" onclick="openRecipeModal(${recipe.id})">
                        <div class="recipe-image${recipe.image ? ' has-img' : ''}" style="position:relative;">
                            ${recipe.image
                                ? `<img src="${recipe.image}" alt="" style="width:100%;height:100%;object-fit:cover;">`
                                : (recipe.emoji || '')}
                        </div>
                        <div class="recipe-info">
                            <h4>${recipe.name}</h4>
                            <p>${recipe.cookTime} min</p>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load recipes:', err);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon"></div>
                        <p>Failed to load recipes.<br>Make sure the server is running.</p>
                    </div>
                `;
            }
        }

        async function openFavorites() {
            const overlay = document.getElementById('favoritesOverlay');
            const grid = document.getElementById('favoritesGrid');
            overlay.classList.add('active');

            try {
                const likedRecipes = await TenderAPI.getLikedRecipes();
                document.getElementById('favoritesCount').textContent =
                    likedRecipes.length + ' recipe' + (likedRecipes.length !== 1 ? 's' : '');

                if (likedRecipes.length === 0) {
                    grid.innerHTML = `
                        <div class="favorites-empty" style="grid-column: 1 / -1;">
                            <div class="empty-icon"></div>
                            <h2>No favorites yet</h2>
                            <p>Start swiping to find recipes you love!</p>
                            <button class="favorites-back-btn" style="margin-top: 20px;" onclick="closeFavorites(); switchPage('swipe');">Start Swiping</button>
                        </div>`;
                    return;
                }

                grid.innerHTML = likedRecipes.map(recipe => `
                    <div class="discover-recipe-card" data-recipe-id="${recipe.id}" onclick="openRecipeModal(${recipe.id})">
                        <div class="discover-recipe-image${recipe.image ? ' has-img' : ''}">
                            ${recipe.image
                                ? `<img src="${recipe.image}" alt="${escapeHtml(recipe.name)}">`
                                : (recipe.emoji || '')}
                            ${recipe.cuisine ? `<span class="cuisine-badge">${capitalizeFirst(recipe.cuisine)}</span>` : ''}
                            <span class="difficulty-badge">${capitalizeFirst(recipe.difficulty || 'medium')}</span>
                        </div>
                    <div class="discover-recipe-body">
                            <div class="discover-recipe-top">
                                <h3>${escapeHtml(recipe.name)}</h3>
                                ${canManageRecipe(recipe.id) ? `
                                    <div class="discover-admin-actions" onclick="event.stopPropagation()">
                                        <button class="card-icon-btn edit" title="Edit recipe" aria-label="Edit recipe" onclick="event.stopPropagation(); openEditRecipeModal(${recipe.id})"></button>
                                        <button class="card-icon-btn delete" title="Delete recipe" aria-label="Delete recipe" onclick="event.stopPropagation(); deleteUserRecipe(${recipe.id})"></button>
                                    </div>
                                ` : ''}
                            </div>
                            <p class="description">${escapeHtml(recipe.description || '')}</p>
                            <div class="discover-recipe-meta">
                                <span> ${recipe.cookTime || '?'} min</span>
                                <span> ${recipe.servings || '?'} servings</span>
                            <span class="likes-count">&#10084; ${recipe.likesCount || 0} likes</span>
                            </div>
                            <div class="discover-recipe-actions" onclick="event.stopPropagation()">
                                <button class="btn-like liked" onclick="unfavorite(${recipe.id}, this)"> Liked</button>
                                <button class="btn-add-plan" onclick="openScheduleFromDiscover(${recipe.id})"> Add to Plan</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load favorites:', err);
                grid.innerHTML = `
                    <div class="favorites-empty" style="grid-column: 1 / -1;">
                        <div class="empty-icon"></div>
                        <h2>Failed to load favorites</h2>
                        <p>Make sure the server is running.</p>
                    </div>`;
            }
        }

        async function unfavorite(recipeId, btn) {
            try {
                await TenderAPI.unlikeRecipe(recipeId);
                likedRecipeIds.delete(recipeId);
                // Remove card with animation
                const card = btn.closest('.discover-recipe-card');
                card.style.transition = 'opacity 0.3s, transform 0.3s';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    card.remove();
                    // Update count
                    const remaining = document.querySelectorAll('#favoritesGrid .discover-recipe-card').length;
                    document.getElementById('favoritesCount').textContent =
                        remaining + ' recipe' + (remaining !== 1 ? 's' : '');
                    if (remaining === 0) {
                        document.getElementById('favoritesGrid').innerHTML = `
                            <div class="favorites-empty" style="grid-column: 1 / -1;">
                                <div class="empty-icon"></div>
                                <h2>No favorites yet</h2>
                                <p>Start swiping to find recipes you love!</p>
                                <button class="favorites-back-btn" style="margin-top: 20px;" onclick="closeFavorites(); switchPage('swipe');">Start Swiping</button>
                            </div>`;
                    }
                    loadLikedRecipesPreview();
                }, 300);
            } catch (err) {
                console.error('Failed to unlike recipe:', err);
            }
        }

        function closeFavorites() {
            document.getElementById('favoritesOverlay').classList.remove('active');
        }

        async function loadGroceryPreview() {
            const container = document.getElementById('groceryListPreview');
            try {
                const items = await TenderAPI.getGroceryList();
                if (items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon"></div>
                            <p>Your grocery list is empty.<br>Add items below!</p>
                        </div>
                    `;
                    return;
                }
                container.innerHTML = items.slice(0, 5).map(item => `
                    <div class="grocery-item ${item.checked ? 'checked' : ''}" data-id="${item.id}">
                        <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleGroceryItem(${item.id})">
                        <span>${escapeHtml(item.name)}</span>
                        <span class="quantity">${item.quantity > 1 ? 'x' + item.quantity : ''}</span>
                        <button class="delete-btn" onclick="deleteGroceryItem(${item.id})"></button>
                    </div>
                `).join('');
                if (items.length > 5) {
                    container.innerHTML += `
                        <div style="text-align: center; padding: 10px; color: var(--primary); cursor: pointer; font-size: 0.9em;" onclick="switchPage('grocery')">
                            View all ${items.length} items 
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Failed to load grocery list:', err);
            }
        }

        function loadProfileInfo(user) {
            if (!user) return;
            const container = document.getElementById('profileInfo');

            const firstName = user.firstName || '';
            const lastName = user.lastName || '';
            const email = user.email || '';
            const cookingSkill = user.cookingSkill || 'Not set';
            const householdSize = user.householdSize || 'Not set';
            const weeklyBudget = user.weeklyBudget || 'Not set';
            const mealsPerWeek = user.mealsPerWeek || 'Not set';

            const dietary = Array.isArray(user.dietary) && user.dietary.length > 0
                ? user.dietary.map(d => `<span class="tag">${escapeHtml(d)}</span>`).join('')
                : '<span style="color: #888;">None specified</span>';
            const cuisines = Array.isArray(user.cuisines) && user.cuisines.length > 0
                ? user.cuisines.slice(0, 5).map(c => `<span class="tag">${escapeHtml(c)}</span>`).join('')
                : '<span style="color: #888;">None specified</span>';

            container.innerHTML = `
                <div class="profile-field">
                    <label>Full Name</label>
                    <span>${escapeHtml(firstName)} ${escapeHtml(lastName)}</span>
                </div>
                <div class="profile-field">
                    <label>Email</label>
                    <span>${escapeHtml(email)}</span>
                </div>
                <div class="profile-field">
                    <label>Cooking Skill</label>
                    <span>${capitalizeFirst(cookingSkill)}</span>
                </div>
                <div class="profile-field">
                    <label>Household Size</label>
                    <span>${householdSize} ${householdSize === '1' ? 'person' : 'people'}</span>
                </div>
                <div class="profile-field">
                    <label>Weekly Budget</label>
                    <span>${capitalizeFirst(weeklyBudget)}</span>
                </div>
                <div class="profile-field">
                    <label>Meals Per Week</label>
                    <span>${mealsPerWeek}</span>
                </div>
                <div class="profile-field">
                    <label>Dietary Restrictions</label>
                    <div class="preferences-tags">${dietary}</div>
                </div>
                <div class="profile-field">
                    <label>Favorite Cuisines</label>
                    <div class="preferences-tags">${cuisines}</div>
                </div>
            `;
        }

        // ==================== EDIT PROFILE ====================
        function openEditProfileModal() {
            if (!currentUser) return;

            // Populate fields with current values
            document.getElementById('editFirstName').value = currentUser.firstName || '';
            document.getElementById('editLastName').value = currentUser.lastName || '';
            document.getElementById('editCookingSkill').value = currentUser.cookingSkill || 'intermediate';
            document.getElementById('editHouseholdSize').value = currentUser.householdSize || '2';
            document.getElementById('editWeeklyBudget').value = currentUser.weeklyBudget || 'moderate';
            document.getElementById('editMealsPerWeek').value = currentUser.mealsPerWeek || '4-7';

            // Set dietary checkboxes
            const dietaryChecks = document.querySelectorAll('#editDietary input[type="checkbox"]');
            const userDietary = Array.isArray(currentUser.dietary) ? currentUser.dietary : [];
            dietaryChecks.forEach(cb => {
                cb.checked = userDietary.includes(cb.value);
            });

            // Set cuisine checkboxes
            const cuisineChecks = document.querySelectorAll('#editCuisines input[type="checkbox"]');
            const userCuisines = Array.isArray(currentUser.cuisines) ? currentUser.cuisines : [];
            cuisineChecks.forEach(cb => {
                cb.checked = userCuisines.includes(cb.value);
            });

            document.getElementById('editProfileModal').classList.add('active');
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').classList.remove('active');
        }

        async function saveProfile(e) {
            e.preventDefault();

            const saveBtn = document.getElementById('saveProfileBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            const dietary = Array.from(document.querySelectorAll('#editDietary input:checked')).map(cb => cb.value);
            const cuisines = Array.from(document.querySelectorAll('#editCuisines input:checked')).map(cb => cb.value);

            const updates = {
                firstName: document.getElementById('editFirstName').value.trim(),
                lastName: document.getElementById('editLastName').value.trim(),
                cookingSkill: document.getElementById('editCookingSkill').value,
                householdSize: document.getElementById('editHouseholdSize').value,
                weeklyBudget: document.getElementById('editWeeklyBudget').value,
                mealsPerWeek: document.getElementById('editMealsPerWeek').value,
                dietary,
                cuisines
            };

            try {
                const updatedUser = await TenderAPI.updateProfile(updates);
                // Update local state - handle both wrapped and direct response
                currentUser = updatedUser.user || updatedUser;
                TenderDB.setCurrentUser(currentUser);

                // Refresh displayed data
                document.getElementById('userName').textContent = currentUser.firstName;
                document.getElementById('userAvatar').textContent = currentUser.firstName.charAt(0).toUpperCase();
                loadProfileInfo(currentUser);

                closeEditProfileModal();
            } catch (err) {
                console.error('Failed to save profile:', err);
                alert('Failed to save profile. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        async function changePassword(e) {
            e.preventDefault();

            const oldPassword = document.getElementById('oldPasswordInput').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;
            const status = document.getElementById('passwordChangeStatus');
            const btn = document.getElementById('changePasswordBtn');

            status.className = 'security-status';
            status.textContent = '';

            if (newPassword.length < 6) {
                status.classList.add('error');
                status.textContent = 'New password must be at least 6 characters.';
                return;
            }
            if (newPassword !== confirmPassword) {
                status.classList.add('error');
                status.textContent = 'New password and confirmation do not match.';
                return;
            }
            if (oldPassword === newPassword) {
                status.classList.add('error');
                status.textContent = 'New password must be different from current password.';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Changing...';

            try {
                await TenderAPI.changePassword(oldPassword, newPassword);
                status.classList.add('success');
                status.textContent = 'Password updated successfully.';
                document.getElementById('changePasswordForm').reset();
            } catch (err) {
                status.classList.add('error');
                status.textContent = err.message || 'Failed to change password.';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Change Password';
            }
        }

        // Close edit profile modal on overlay click
        document.getElementById('editProfileModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditProfileModal();
        });

        // ==================== CREATE RECIPE MODAL ====================
        function handleImageUpload(input, areaId, dataId) {
            const file = input.files[0];
            if (!file) return;

            // Limit to 5MB
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be under 5MB.');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                document.getElementById(dataId).value = base64;
                const area = document.getElementById(areaId);
                area.classList.add('has-image');
                area.innerHTML = `
                    <img src="${base64}" alt="Recipe image">
                    <button type="button" class="remove-image-btn" onclick="event.stopPropagation(); removeRecipeImage('${areaId}', '${dataId}', '${input.id}')"></button>
                    <input type="file" id="${input.id}" accept="image/*" style="display:none;" onchange="handleImageUpload(this, '${areaId}', '${dataId}')">
                    <input type="hidden" id="${dataId}" value="${base64}">
                `;
            };
            reader.readAsDataURL(file);
        }

        function removeRecipeImage(areaId, dataId, inputId) {
            const area = document.getElementById(areaId);
            area.classList.remove('has-image');
            area.innerHTML = `
                <div class="upload-placeholder"><span></span>Click to upload an image</div>
                <input type="file" id="${inputId}" accept="image/*" style="display:none;" onchange="handleImageUpload(this, '${areaId}', '${dataId}')">
                <input type="hidden" id="${dataId}">
            `;
        }

        function resetImageArea(areaId, dataId, inputId) {
            const area = document.getElementById(areaId);
            area.classList.remove('has-image');
            area.innerHTML = `
                <div class="upload-placeholder"><span></span>Click to upload an image</div>
                <input type="file" id="${inputId}" accept="image/*" style="display:none;" onchange="handleImageUpload(this, '${areaId}', '${dataId}')">
                <input type="hidden" id="${dataId}">
            `;
        }

        function setImageArea(areaId, dataId, inputId, imageUrl) {
            const area = document.getElementById(areaId);
            area.classList.add('has-image');
            area.innerHTML = `
                <img src="${imageUrl}" alt="Recipe image">
                <button type="button" class="remove-image-btn" onclick="event.stopPropagation(); removeRecipeImage('${areaId}', '${dataId}', '${inputId}')"></button>
                <input type="file" id="${inputId}" accept="image/*" style="display:none;" onchange="handleImageUpload(this, '${areaId}', '${dataId}')">
                <input type="hidden" id="${dataId}" value="${imageUrl}">
            `;
        }

        function openCreateRecipeModal() {
            document.getElementById('createRecipeForm').reset();
            resetImageArea('newRecipeImageArea', 'newRecipeImageData', 'newRecipeImageInput');
            document.getElementById('createRecipeModal').classList.add('active');
        }

        function closeCreateRecipeModal() {
            document.getElementById('createRecipeModal').classList.remove('active');
        }

        async function submitNewRecipe(e) {
            e.preventDefault();
            const btn = document.getElementById('submitRecipeBtn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                const name = document.getElementById('newRecipeName').value.trim();
                if (!name) {
                    alert('Recipe name is required.');
                    return;
                }

                const ingredientsText = document.getElementById('newRecipeIngredients').value.trim();
                const ingredients = ingredientsText
                    ? ingredientsText.split('\n').map(l => l.trim()).filter(Boolean)
                    : [];
                const sourceLinkInput = document.getElementById('newRecipeSourceLink').value.trim();
                const sourceLink = sourceLinkInput ? normalizeRecipeLink(sourceLinkInput) : null;
                if (sourceLinkInput && !sourceLink) {
                    alert('Please enter a valid URL starting with http:// or https://');
                    return;
                }

                const imageData = document.getElementById('newRecipeImageData').value || null;
                const data = {
                    name,
                    description: document.getElementById('newRecipeDescription').value.trim(),
                    emoji: document.getElementById('newRecipeEmoji').value.trim() || '',
                    image: imageData,
                    sourceLink,
                    cookTime: parseInt(document.getElementById('newRecipeCookTime').value) || 30,
                    servings: parseInt(document.getElementById('newRecipeServings').value) || 4,
                    difficulty: document.getElementById('newRecipeDifficulty').value,
                    cuisine: document.getElementById('newRecipeCuisine').value,
                    ingredients,
                    instructions: document.getElementById('newRecipeInstructions').value.trim()
                };

                await TenderAPI.createRecipe(data);
                closeCreateRecipeModal();
                await loadDiscoverPage();
            } catch (err) {
                console.error('Failed to create recipe:', err);
                alert('Failed to create recipe. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Recipe';
            }
        }

        // Close create recipe modal on overlay click
        document.getElementById('createRecipeModal').addEventListener('click', function(e) {
            if (e.target === this) closeCreateRecipeModal();
        });

        // ==================== SWIPE PAGE ====================
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        let swipeDeck = [];
        let swipeDeckMaster = [];
        let swipeDifficultyFilter = ''; // '' | 'easy' | 'medium' | 'hard'
        let swipeLikedToday = 0;
        let swipeDragging = false;
        let swipeStartX = 0;
        let swipeStartY = 0;
        let swipeCurrentX = 0;
        let swipeCurrentCard = null;
        let emojiRainGen = 0;
        let emojiRainIntervalId = null;

        function getCuisineClass(cuisine) {
            const c = (cuisine || '').toLowerCase();
            const map = ['italian','mexican','chinese','japanese','indian','thai','mediterranean','american','french','korean','greek','vietnamese','british'];
            return map.includes(c) ? `cuisine-bg-${c}` : 'cuisine-bg-default';
        }

        async function loadSwipePage() {
            renderSwipeDietaryTags();
            if (swipeDeck.length > 0) { renderSwipeCard(); return; }
            try {
                let recipes = await TenderAPI.getDiscoverRecipes(50);
                if (!Array.isArray(recipes) || recipes.length === 0) {
                    try {
                        recipes = await TenderAPI.getRecipes();
                    } catch (fallbackErr) {
                        console.error('Fallback getRecipes failed:', fallbackErr);
                        recipes = [];
                    }
                }
                recipes = filterByDietary(recipes);
                shuffleArray(recipes);
                swipeDeckMaster = recipes.slice();
                applySwipeFilters();
            } catch (err) {
                console.error('Failed to load swipe recipes:', err);
                document.getElementById('swipeContainer').innerHTML = `
                    <div class="swipe-empty">
                        <div class="empty-icon">??????</div>
                        <h2>Oops!</h2>
                        <p>Couldn't load recipes. Make sure the server is running.</p>
                    </div>`;
            }
        }

        function renderSwipeCard() {
            const container = document.getElementById('swipeContainer');

            if (swipeDeck.length === 0) {
                if (swipeDeckMaster.length > 0) {
                    let refill = swipeDeckMaster.slice();
                    if (swipeDifficultyFilter) {
                        refill = refill.filter(r => (r.difficulty || 'medium') === swipeDifficultyFilter);
                    }
                    if (refill.length > 0) {
                        swipeDeck = shuffleArray(refill);
                        renderSwipeCard();
                        return;
                    }
                    // No recipes match current difficulty filter
                    container.innerHTML = `
                        <div class="swipe-empty">
                            <div class="empty-icon"></div>
                            <h2>No ${capitalizeFirst(swipeDifficultyFilter)} Recipes</h2>
                            <p>No recipes match this difficulty.<br>Try a different filter above.</p>
                        </div>`;
                    document.getElementById('swipeActions').style.display = 'none';
                    return;
                }
                container.innerHTML = `
                    <div class="swipe-empty">
                        <div class="empty-icon">???????</div>
                        <h2>Loading more recipes...</h2>
                        <p>Hang tight while we refresh your deck.</p>
                    </div>`;
                document.getElementById('swipeActions').style.display = 'none';
                loadSwipePage();
                return;
            }

            document.getElementById('swipeActions').style.display = 'flex';
            const recipe = swipeDeck[0];
            const ingredients = recipe.ingredients || [];
            const previewIngredients = ingredients.slice(0, 4);

            container.innerHTML = `
                <div class="swipe-card" id="activeSwipeCard">
                    <div class="swipe-card-bg${recipe.image ? ' has-img' : ''}">
                        <div class="swipe-card-bg-gradient ${getCuisineClass(recipe.cuisine)}"></div>
                        ${recipe.image ? `<img class="swipe-card-img" src="${recipe.image}" alt="${escapeHtml(recipe.name)}">` : ''}
                        ${recipe.cuisine ? `<span class="swipe-card-cuisine">${capitalizeFirst(recipe.cuisine)}</span>` : ''}
                        <span class="swipe-card-difficulty ${(recipe.difficulty || 'medium').toLowerCase()}">${capitalizeFirst(recipe.difficulty || 'medium')}</span>
                        <span class="swipe-card-emoji">${recipe.emoji || ''}</span>
                        ${isAdmin ? (() => {
                            const gfState = computeRecipeGFState(recipe);
                            const isGF = gfState === 'confirmed' || gfState === 'natural';
                            const btnClass = gfState === 'denied' ? 'denied' : (isGF ? 'active' : '');
                            const btnLabel = isGF ? '- GF' : '+ GF';
                            const btnTitle = gfState === 'denied'   ? 'Marked NOT gluten-free  click to mark as GF'
                                           : gfState === 'confirmed' ? 'Manually confirmed GF  click to un-confirm'
                                           : gfState === 'natural'   ? 'Passes GF filter  click to mark as NOT GF'
                                           :                           'Fails GF filter  click to mark as GF';
                            return `<button class="swipe-gf-btn${btnClass ? ' ' + btnClass : ''}" id="swipeGFBtn"
                                onpointerdown="event.stopPropagation()"
                                onclick="swipeToggleGlutenFree(event,${recipe.id})"
                                title="${btnTitle}">${btnLabel}</button>`;
                        })() : ''}
                    </div>
                    <div class="swipe-card-body">
                        <div class="swipe-card-name">${escapeHtml(recipe.name)}</div>
                        <div class="swipe-card-desc">${escapeHtml(recipe.description || '')}</div>
                        <div class="swipe-card-stats">
                            <span class="swipe-card-stat"><span class="stat-icon"></span> ${recipe.cookTime || '?'} min</span>
                            <span class="swipe-card-stat"><span class="stat-icon"></span> ${recipe.servings || '?'} servings</span>
                        </div>
                        <div class="swipe-card-ingredients-peek">
                            ${previewIngredients.map(i => `<span class="ing-tag">${escapeHtml(i.trim())}</span>`).join('')}
                            ${ingredients.length > 4 ? `<span class="ing-tag">+${ingredients.length - 4} more</span>` : ''}
                        </div>
                    </div>
                    <div class="swipe-stamp swipe-stamp-like" id="stampLike">LIKE</div>
                    <div class="swipe-stamp swipe-stamp-nope" id="stampNope">NOPE</div>
                </div>`;

            // Set up drag/touch events on the new card
            const card = document.getElementById('activeSwipeCard');
            swipeCurrentCard = card;

            card.addEventListener('pointerdown', swipePointerDown);
            card.addEventListener('pointermove', swipePointerMove);
            card.addEventListener('pointerup', swipePointerUp);
            card.addEventListener('pointercancel', swipePointerUp);

            // Emoji rain for current recipe
            startEmojiRain(recipe.emoji || '???');
            // Reset swipe background for the new card
            setSwipeBackground(0);
        }

        function setSwipeBackground(x) {
            const bg = document.getElementById('swipeBg');
            if (!bg) return;

            const max = 220;
            const strength = Math.min(Math.abs(x) / max, 1);
            if (strength === 0) {
                bg.style.backgroundColor = 'transparent';
                return;
            }

            const alpha = 0.18 * strength;
            if (x > 0) {
                bg.style.backgroundColor = `rgba(76, 217, 100, ${alpha})`;
            } else {
                bg.style.backgroundColor = `rgba(255, 99, 71, ${alpha})`;
            }
        }

        function startEmojiRain(emoji) {
            stopEmojiRain(false);
            // Spawn immediately, then keep a steady flow.
            spawnEmojiRainBurst(emoji);
            emojiRainIntervalId = setInterval(() => {
                spawnEmojiRainBurst(emoji);
            }, 2200);
        }

        function stopEmojiRain(clearParticles = true) {
            if (emojiRainIntervalId) {
                clearInterval(emojiRainIntervalId);
                emojiRainIntervalId = null;
            }
            // Invalidate pending delayed spawns.
            emojiRainGen += 1;

            if (!clearParticles) return;
            const container = document.getElementById('emojiRainContainer');
            if (container) container.innerHTML = '';
        }

        function spawnEmojiRainBurst(emoji) {
            const swipePage = document.getElementById('page-swipe');
            if (!swipePage || !swipePage.classList.contains('active')) return;

            const container = document.getElementById('emojiRainContainer');
            if (!container) return;
            // Prevent delayed particles from older recipes appearing after a new card.
            emojiRainGen += 1;
            const gen = emojiRainGen;

            const count = 12;
            for (let i = 0; i < count; i++) {
                const delay = Math.random() * 0.8;
                setTimeout(() => {
                    if (gen !== emojiRainGen) return;
                    if (!swipePage.classList.contains('active')) return;

                    const particle = document.createElement('div');
                    particle.className = 'emoji-rain-particle';
                    particle.textContent = emoji;

                    const size = 0.6 + Math.random() * 2.2;
                    const left = Math.random() * 100;
                    const duration = 4 + Math.random() * 6;
                    const startRot = (Math.random() - 0.5) * 360;
                    const endRot = startRot + (Math.random() - 0.5) * 540;
                    const opacity = 0.15 + Math.random() * 0.35;

                    particle.style.fontSize = size + 'em';
                    particle.style.left = left + '%';
                    particle.style.animationDuration = duration + 's';
                    particle.style.animationDelay = '0s';
                    particle.style.setProperty('--start-rot', startRot + 'deg');
                    particle.style.setProperty('--end-rot', endRot + 'deg');
                    particle.style.setProperty('--particle-opacity', opacity);

                    particle.addEventListener('animationend', () => {
                        particle.remove();
                    });
                    container.appendChild(particle);
                }, delay * 1000);
            }
        }

        function swipePointerDown(e) {
            if (e.button !== 0) return; // left click only
            swipeDragging = true;
            swipeStartX = e.clientX;
            swipeStartY = e.clientY;
            swipeCurrentX = 0;
            this.setPointerCapture(e.pointerId);
            this.style.transition = 'none';
        }

        function swipePointerMove(e) {
            if (!swipeDragging) return;
            swipeCurrentX = e.clientX - swipeStartX;
            const rotate = swipeCurrentX * 0.08;
            this.style.transform = `translateX(${swipeCurrentX}px) rotate(${rotate}deg)`;
            setSwipeBackground(swipeCurrentX);

            // Show stamps based on direction
            const threshold = 60;
            const likeStamp = document.getElementById('stampLike');
            const nopeStamp = document.getElementById('stampNope');

            if (swipeCurrentX > threshold) {
                likeStamp.style.opacity = Math.min((swipeCurrentX - threshold) / 80, 1);
                nopeStamp.style.opacity = 0;
            } else if (swipeCurrentX < -threshold) {
                nopeStamp.style.opacity = Math.min((-swipeCurrentX - threshold) / 80, 1);
                likeStamp.style.opacity = 0;
            } else {
                likeStamp.style.opacity = 0;
                nopeStamp.style.opacity = 0;
            }
        }

        function swipePointerUp(e) {
            if (!swipeDragging) return;
            swipeDragging = false;

            // Quick tap (barely moved)  open recipe details
            if (Math.abs(swipeCurrentX) < 8) {
                this.style.transition = 'transform 0.35s cubic-bezier(0.2, 0, 0, 1)';
                this.style.transform = 'translateX(0) rotate(0)';
                setSwipeBackground(0);
                if (swipeDeck.length > 0) showRecipeModal(swipeDeck[0]);
                return;
            }

            const threshold = 100;
            if (swipeCurrentX > threshold) {
                completeSwipe('like');
            } else if (swipeCurrentX < -threshold) {
                completeSwipe('nope');
            } else {
                // Snap back
                this.style.transition = 'transform 0.35s cubic-bezier(0.2, 0, 0, 1)';
                this.style.transform = 'translateX(0) rotate(0)';
                document.getElementById('stampLike').style.opacity = 0;
                document.getElementById('stampNope').style.opacity = 0;
                setSwipeBackground(0);
            }
        }

        async function swipeToggleGlutenFree(e, recipeId) {
            e.stopPropagation();
            if (!isAdmin) return;

            const recipe = swipeDeckMaster.find(r => r.id === recipeId);
            if (!recipe) return;

            const gfState = computeRecipeGFState(recipe);
            const currentlyGF = gfState === 'confirmed' || gfState === 'natural';

            // Strip any existing GF overrides, then apply the opposite
            const base = (Array.isArray(recipe.dietaryOverrides) ? recipe.dietaryOverrides : [])
                .filter(d => d !== 'gluten-free' && d !== '!gluten-free');
            const newOverrides = currentlyGF
                ? [...base, '!gluten-free']  // was GF  mark as NOT GF
                : [...base, 'gluten-free'];   // was not GF  mark as GF

            try {
                await TenderAPI.setRecipeDietary(recipeId, newOverrides);
                recipe.dietaryOverrides = newOverrides;

                const btn = document.getElementById('swipeGFBtn');
                if (btn) {
                    const newState = computeRecipeGFState(recipe);
                    const nowGF = newState === 'confirmed' || newState === 'natural';
                    btn.className = 'swipe-gf-btn' + (newState === 'denied' ? ' denied' : nowGF ? ' active' : '');
                    btn.textContent = nowGF ? '- GF' : '+ GF';
                    btn.title = nowGF ? 'Passes GF filter  click to mark as NOT GF'
                                      : 'Marked NOT gluten-free  click to mark as GF';
                }
            } catch (err) {
                console.error('Failed to update gluten-free status:', err);
                alert('Failed to update. Please try again.');
            }
        }

        function swipeAction(direction) {
            const card = document.getElementById('activeSwipeCard');
            if (!card) return;

            // Show stamp
            const stamp = direction === 'like' ? document.getElementById('stampLike') : document.getElementById('stampNope');
            stamp.style.opacity = 1;

            completeSwipe(direction);
        }

        async function completeSwipe(direction) {
            const card = document.getElementById('activeSwipeCard');
            if (!card || swipeDeck.length === 0) return;

            const recipe = swipeDeck[0];
            const xOut = direction === 'like' ? window.innerWidth : -window.innerWidth;

            // Fade background back to neutral
            setSwipeBackground(0);

            // Stop any delayed particles from the current card from spawning after the swipe.
            emojiRainGen += 1;

            // Animate card off screen
            card.classList.add('animating');
            card.style.transform = `translateX(${xOut}px) rotate(${direction === 'like' ? 30 : -30}deg)`;
            card.style.opacity = '0';

            // API call
            try {
                if (direction === 'like') {
                    await TenderAPI.likeRecipe(recipe.id);
                    likedRecipeIds.add(recipe.id);
                    swipeLikedToday++;
                    document.getElementById('swipeCounter').textContent = `${swipeLikedToday} recipe${swipeLikedToday !== 1 ? 's' : ''} liked today`;
                } else {
                    await TenderAPI.dislikeRecipe(recipe.id);
                }
            } catch (err) {
                console.error('Swipe action failed:', err);
            }

            // Wait for animation, then show next card
            setTimeout(() => {
                swipeDeck.shift();
                renderSwipeCard();
            }, 350);
        }

        function swipeShowDetails() {
            if (swipeDeck.length === 0) return;
            const recipe = swipeDeck[0];
            // Re-use the existing recipe modal
            showRecipeModal(recipe);
        }

        let scheduleRecipeId = null;
        let scheduleDate = null;
        let scheduleMeal = 'dinner';
        let schedulePlanData = []; // meal plan snapshot for the schedule modal

        async function swipeAddToPlan() {
            if (swipeDeck.length === 0) return;
            const recipe = swipeDeck[0];

            // Like it first
            try {
                await TenderAPI.likeRecipe(recipe.id);
                likedRecipeIds.add(recipe.id);
            } catch (err) {
                // May already be liked
            }

            swipeLikedToday++;
            document.getElementById('swipeCounter').textContent = `${swipeLikedToday} recipe${swipeLikedToday !== 1 ? 's' : ''} liked today`;

            // Animate card up and away
            const card = document.getElementById('activeSwipeCard');
            if (card) {
                card.classList.add('animating');
                card.style.transform = `translateY(-${window.innerHeight}px) scale(0.5)`;
                card.style.opacity = '0';
                setTimeout(() => {
                    swipeDeck.shift();
                    renderSwipeCard();
                }, 350);
            }

            // Open the schedule modal
            openScheduleModal(recipe);
        }

        async function openScheduleModal(recipe) {
            scheduleRecipeId = recipe.id;
            document.getElementById('scheduleRecipeEmoji').textContent = recipe.emoji || '';
            document.getElementById('scheduleRecipeName').textContent = recipe.name;

            // Fetch current meal plan
            try {
                schedulePlanData = await TenderAPI.getMealPlan();
            } catch (err) {
                console.error('Failed to load meal plan for schedule modal:', err);
                schedulePlanData = [];
            }

            // Also ensure we have all recipes loaded (for showing existing meal names)
            if (allRecipes.length === 0) {
                try { allRecipes = await TenderAPI.getRecipes(); } catch(e) {}
            }

            // Build the day picker
            const daysContainer = document.getElementById('scheduleDays');
            const today = new Date();
            const todayStr = formatDate(today);
            const shortDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const mealSlots = ['breakfast', 'lunch', 'dinner'];

            let daysHtml = '';
            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() + i);
                const dateStr = formatDate(d);
                const isToday = i === 0;

                // Count how many meals are planned for this day
                const dayMeals = schedulePlanData.filter(m => m.plan_date === dateStr);
                const dots = mealSlots.map(slot => {
                    const filled = dayMeals.some(m => m.meal_type === slot);
                    return `<span class="day-dot ${filled ? 'filled' : ''}"></span>`;
                }).join('');

                daysHtml += `
                    <button class="schedule-day-btn ${isToday ? 'active today' : ''}"
                            data-date="${dateStr}"
                            onclick="pickScheduleDay(this)">
                        <span class="day-name">${shortDays[d.getDay()]}</span>
                        <span class="day-num">${d.getDate()}</span>
                        <span class="day-dots">${dots}</span>
                    </button>`;
            }
            daysContainer.innerHTML = daysHtml;

            // Default to today + dinner
            scheduleDate = todayStr;
            scheduleMeal = 'dinner';

            // Render day preview and meal buttons for the default day
            renderScheduleDayPreview(todayStr);
            renderScheduleMealButtons(todayStr);

            document.getElementById('scheduleRecipeModal').classList.add('active');
        }

        function getPlannedMealsForSlot(dateStr, mealType) {
            return schedulePlanData.filter(m => m.plan_date === dateStr && m.meal_type === mealType);
        }

        function renderScheduleDayPreview(dateStr) {
            const preview = document.getElementById('scheduleDayPreview');
            const d = new Date(dateStr + 'T12:00:00');
            const label = d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            const slots = ['breakfast', 'lunch', 'dinner'];
            const icons = { breakfast: '\u{1F305}', lunch: '\u2600\uFE0F', dinner: '\u{1F319}' };

            const slotRows = slots.map(slot => {
                const plannedMeals = getPlannedMealsForSlot(dateStr, slot);
                if (plannedMeals.length > 0) {
                    const previewMeals = plannedMeals
                        .slice(0, 2)
                        .map(m => `<span class="slot-emoji">${m.recipe_emoji || '&#127869;'}</span> ${escapeHtml(m.recipe_name || 'Unknown')}`)
                        .join(' | ');
                    const more = plannedMeals.length > 2 ? ` +${plannedMeals.length - 2} more` : '';
                    return `<div class="schedule-preview-slot">
                        <span class="slot-time">${icons[slot]} ${capitalizeFirst(slot)}</span>
                        <span class="slot-recipe">${previewMeals}${more}</span>
                    </div>`;
                }
                return `<div class="schedule-preview-slot">
                    <span class="slot-time">${icons[slot]} ${capitalizeFirst(slot)}</span>
                    <span class="slot-empty">- empty -</span>
                </div>`;
            }).join('');

            const allEmpty = slots.every(s => getPlannedMealsForSlot(dateStr, s).length === 0);

            preview.innerHTML = `
                <div class="schedule-day-preview-title">${label}</div>
                ${allEmpty
                    ? '<div class="schedule-day-preview-empty">Nothing planned yet - this day is wide open!</div>'
                    : slotRows}
            `;
        }

        function renderScheduleMealButtons(dateStr) {
            const container = document.getElementById('scheduleMeals');
            const slots = ['breakfast', 'lunch', 'dinner'];
            const icons = { breakfast: '\u{1F305}', lunch: '\u2600\uFE0F', dinner: '\u{1F319}' };

            // Pick the least filled slot as default (ties keep breakfast->lunch->dinner order)
            let defaultMeal = 'dinner';
            let minCount = Number.POSITIVE_INFINITY;
            for (const slot of slots) {
                const count = getPlannedMealsForSlot(dateStr, slot).length;
                if (count < minCount) {
                    minCount = count;
                    defaultMeal = slot;
                }
            }
            scheduleMeal = defaultMeal;

            container.innerHTML = slots.map(slot => {
                const plannedMeals = getPlannedMealsForSlot(dateStr, slot);
                const isActive = slot === defaultMeal;
                const occupiedClass = plannedMeals.length > 0 ? 'occupied' : '';
                const existingLabel = plannedMeals.length > 0
                    ? `<span class="meal-existing">${plannedMeals.length} dish${plannedMeals.length !== 1 ? 'es' : ''} planned</span>`
                    : `<span class="meal-existing">Available</span>`;

                return `<button class="schedule-meal-btn ${isActive ? 'active' : ''} ${occupiedClass}"
                                data-meal="${slot}"
                                onclick="pickScheduleMeal(this)">
                    <span class="meal-label">${icons[slot]} ${capitalizeFirst(slot)}</span>
                    ${existingLabel}
                </button>`;
            }).join('');
        }

        function pickScheduleDay(btn) {
            document.querySelectorAll('.schedule-day-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            scheduleDate = btn.dataset.date;
            renderScheduleDayPreview(scheduleDate);
            renderScheduleMealButtons(scheduleDate);
        }

        function pickScheduleMeal(btn) {
            document.querySelectorAll('.schedule-meal-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            scheduleMeal = btn.dataset.meal;
        }

        function closeScheduleModal() {
            document.getElementById('scheduleRecipeModal').classList.remove('active');
            scheduleRecipeId = null;
        }

        async function confirmScheduleRecipe() {
            if (!scheduleRecipeId || !scheduleDate || !scheduleMeal) return;

            try {
                const course = getPlannedMealsForSlot(scheduleDate, scheduleMeal).length > 0 ? 'secondary' : 'main';
                await TenderAPI.addToMealPlan(scheduleRecipeId, scheduleDate, scheduleMeal, course);
                closeScheduleModal();
                switchPage('mealplan');
            } catch (err) {
                console.error('Failed to schedule recipe:', err);
                alert('Failed to add to meal plan. Please try again.');
            }
        }

        // Close schedule modal on overlay click
        document.getElementById('scheduleRecipeModal').addEventListener('click', function(e) {
            if (e.target === this) closeScheduleModal();
        });

        // Open schedule modal from Discover page (uses recipe ID to find the recipe object)
        async function openScheduleFromDiscover(recipeId) {
            let recipe = allRecipes.find(r => r.id === recipeId);
            if (!recipe) {
                try { recipe = await TenderAPI.getRecipe(recipeId); } catch(e) {}
            }
            if (!recipe) return;
            openScheduleModal(recipe);
        }

        // ==================== DISCOVER PAGE ====================
        async function loadDiscoverPage() {
            try {
                allRecipes = await TenderAPI.getRecipes();
                const [likedRecipes, myRecipes] = await Promise.all([
                    TenderAPI.getLikedRecipes(),
                    TenderAPI.getMyRecipes().catch(() => [])
                ]);
                likedRecipeIds = new Set(likedRecipes.map(r => r.id));
                myRecipeIds = new Set(myRecipes.map(r => String(r.id)));

                // Initialize discover dietary filters from user profile
                const userDietary = currentUser && Array.isArray(currentUser.dietary) ? currentUser.dietary : [];
                discoverDietaryFilters = new Set(userDietary);
                renderDiscoverDietaryChips();

                renderDiscoverCarousel(allRecipes);
                populateCuisineFilter();
                filterRecipes();
            } catch (err) {
                console.error('Failed to load discover:', err);
                const carousel = document.getElementById('discoverCarousel');
                if (carousel) carousel.style.display = 'none';
                document.getElementById('discoverGrid').innerHTML = `
                    <div class="no-results">
                        <div class="icon"></div>
                        <p>Failed to load recipes. Make sure the server is running.</p>
                    </div>
                `;
            }
        }

        function populateCuisineFilter() {
            const cuisines = [...new Set(allRecipes.map(r => r.cuisine).filter(Boolean))].sort();
            const select = document.getElementById('cuisineFilter');
            // Keep first option, remove rest
            select.innerHTML = '<option value="">All Cuisines</option>';
            cuisines.forEach(c => {
                select.innerHTML += `<option value="${c}">${capitalizeFirst(c)}</option>`;
            });

            // Build cuisine chips
            const chipsContainer = document.getElementById('cuisineChips');
            chipsContainer.innerHTML = `<button class="filter-chip active" onclick="selectCuisineChip(this, '')">All</button>`;
            cuisines.forEach(c => {
                chipsContainer.innerHTML += `<button class="filter-chip" onclick="selectCuisineChip(this, '${c}')">${capitalizeFirst(c)}</button>`;
            });
        }

        function renderDiscoverCarousel(recipes) {
            const carousel = document.getElementById('discoverCarousel');
            const track = document.getElementById('discoverCarouselTrack');
            if (!carousel || !track) return;

            const source = (Array.isArray(recipes) ? recipes : []).filter(r => r && r.id).slice(0, 20);
            if (source.length < 2) {
                carousel.style.display = 'none';
                track.innerHTML = '';
                return;
            }

            carousel.style.display = 'block';

            const itemHtml = source.map(recipe => `
                <div class="discover-carousel-item" onclick="openRecipeModal(${recipe.id})" title="${escapeHtml(recipe.name || 'Recipe')}">
                    <div class="discover-carousel-thumb">
                        ${recipe.image
                            ? `<img src="${recipe.image}" alt="${escapeHtml(recipe.name || 'Recipe')}">`
                            : (recipe.emoji || '')}
                    </div>
                    <div class="discover-carousel-name">${escapeHtml(recipe.name || 'Untitled Recipe')}</div>
                </div>
            `).join('');

            // Duplicate for seamless infinite scrolling.
            track.innerHTML = itemHtml + itemHtml;

            // Fast, but still readable speed. Scale with item count.
            const durationSec = Math.max(14, Math.min(36, source.length * 1.4));
            track.style.setProperty('--discover-carousel-duration', `${durationSec}s`);
        }

        function selectCuisineChip(chip, cuisine) {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            document.getElementById('cuisineFilter').value = cuisine;
            filterRecipes();
        }

        function filterRecipes() {
            const search = document.getElementById('searchInput').value.toLowerCase().trim();
            const cuisine = document.getElementById('cuisineFilter').value;
            const difficulty = document.getElementById('difficultyFilter').value;

            // Apply dietary filters from the toggleable chips
            const activeDietary = [...discoverDietaryFilters];
            let filtered = filterByDietary(allRecipes, activeDietary);

            filtered = filtered.filter(recipe => {
                const matchesSearch = !search ||
                    recipe.name.toLowerCase().includes(search) ||
                    (recipe.description && recipe.description.toLowerCase().includes(search)) ||
                    (recipe.ingredients && recipe.ingredients.some(i => i.toLowerCase().includes(search)));
                const matchesCuisine = !cuisine || recipe.cuisine === cuisine;
                const matchesDifficulty = !difficulty || recipe.difficulty === difficulty;
                return matchesSearch && matchesCuisine && matchesDifficulty;
            });

            // Most-liked recipes first.
            filtered.sort((a, b) => {
                const likesA = Number(a.likesCount || 0);
                const likesB = Number(b.likesCount || 0);
                if (likesB !== likesA) return likesB - likesA;
                return Number(a.id || 0) - Number(b.id || 0);
            });

            renderDiscoverGrid(filtered);
        }

        function renderDiscoverGrid(recipes) {
            const grid = document.getElementById('discoverGrid');

            if (recipes.length === 0) {
                grid.innerHTML = `
                    <div class="no-results">
                        <div class="icon"></div>
                        <p>No recipes found matching your filters.<br>Try adjusting your search.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = recipes.map(recipe => `
                <div class="discover-recipe-card" data-recipe-id="${recipe.id}" onclick="openRecipeModal(${recipe.id})">
                    <div class="discover-recipe-image${recipe.image ? ' has-img' : ''}">
                        ${recipe.image
                            ? `<img src="${recipe.image}" alt="${escapeHtml(recipe.name)}">`
                            : (recipe.emoji || '')}
                        ${recipe.cuisine ? `<span class="cuisine-badge">${capitalizeFirst(recipe.cuisine)}</span>` : ''}
                        <span class="difficulty-badge">${capitalizeFirst(recipe.difficulty || 'medium')}</span>
                    </div>
                    <div class="discover-recipe-body">
                        <div class="discover-recipe-top">
                            <h3>${escapeHtml(recipe.name)}</h3>
                            ${canManageRecipe(recipe.id) ? `
                                <div class="discover-admin-actions" onclick="event.stopPropagation()">
                                    <button class="card-icon-btn edit" title="Edit recipe" aria-label="Edit recipe" onclick="event.stopPropagation(); openEditRecipeModal(${recipe.id})"></button>
                                    <button class="card-icon-btn delete" title="Delete recipe" aria-label="Delete recipe" onclick="event.stopPropagation(); deleteUserRecipe(${recipe.id})"></button>
                                </div>
                            ` : ''}
                        </div>
                        <p class="description">${escapeHtml(recipe.description || '')}</p>
                        <div class="discover-recipe-meta">
                            <span> ${recipe.cookTime} min</span>
                            <span> ${recipe.servings} servings</span>
                            <span class="likes-count">&#10084; ${recipe.likesCount || 0} likes</span>
                        </div>
                        <div class="discover-recipe-actions" onclick="event.stopPropagation()">
                            <button class="btn-like ${likedRecipeIds.has(recipe.id) ? 'liked' : ''}" onclick="toggleLike(${recipe.id}, this)">
                                ${likedRecipeIds.has(recipe.id) ? ' Liked' : ' Like'}
                            </button>
                            <button class="btn-add-plan" onclick="openScheduleFromDiscover(${recipe.id})"> Add to Plan</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function applyRecipeLikeDelta(recipeId, delta) {
            const recipe = allRecipes.find(r => Number(r.id) === Number(recipeId));
            if (recipe) {
                recipe.likesCount = Math.max(0, Number(recipe.likesCount || 0) + delta);
            }

            document.querySelectorAll(`.discover-recipe-card[data-recipe-id="${recipeId}"] .likes-count`).forEach(el => {
                const current = Number((el.textContent.match(/\d+/) || ['0'])[0]);
                const next = Math.max(0, current + delta);
                el.innerHTML = `&#10084; ${next} likes`;
            });
        }

        async function toggleLike(recipeId, btn) {
            try {
                if (likedRecipeIds.has(recipeId)) {
                    await TenderAPI.unlikeRecipe(recipeId);
                    likedRecipeIds.delete(recipeId);
                    applyRecipeLikeDelta(recipeId, -1);
                    btn.classList.remove('liked');
                    btn.innerHTML = ' Like';
                } else {
                    await TenderAPI.likeRecipe(recipeId);
                    likedRecipeIds.add(recipeId);
                    applyRecipeLikeDelta(recipeId, 1);
                    btn.classList.add('liked');
                    btn.innerHTML = ' Liked';
                }
            } catch (err) {
                console.error('Failed to toggle like:', err);
            }
        }

        // ==================== RECIPE MODAL ====================
        async function openRecipeModal(recipeId) {
            const recipe = allRecipes.find(r => r.id === recipeId);
            if (!recipe) {
                try {
                    const fetched = await TenderAPI.getRecipe(recipeId);
                    showRecipeModal(fetched);
                } catch (err) {
                    console.error('Failed to load recipe:', err);
                }
                return;
            }
            showRecipeModal(recipe);
        }

        function extractFirstUrl(text) {
            if (typeof text !== 'string') return null;
            const match = text.match(/https?:\/\/[^\s<>"')]+/i);
            if (!match) return null;
            return match[0].replace(/[.,;!?]+$/, '');
        }

        function normalizeRecipeLink(value) {
            if (typeof value !== 'string' || !value.trim()) return null;
            try {
                const url = new URL(value.trim());
                if (url.protocol !== 'http:' && url.protocol !== 'https:') return null;
                return url.href;
            } catch (_) {
                return null;
            }
        }

        function getRecipeSourceLink(recipe) {
            if (!recipe || typeof recipe !== 'object') return null;

            const directCandidates = [
                recipe.link,
                recipe.sourceLink,
                recipe.sourceUrl,
                recipe.source_url
            ];

            for (const candidate of directCandidates) {
                const normalized = normalizeRecipeLink(candidate);
                if (normalized) return normalized;
            }

            const extractedCandidates = [
                extractFirstUrl(recipe.instructions || ''),
                extractFirstUrl(recipe.description || '')
            ];

            for (const candidate of extractedCandidates) {
                const normalized = normalizeRecipeLink(candidate);
                if (normalized) return normalized;
            }

            return null;
        }

        function showRecipeModal(recipe) {
            const banner = document.getElementById('modalImageBanner');
            if (recipe.image) {
                banner.style.display = 'block';
                document.getElementById('modalBannerImg').src = recipe.image;
                document.getElementById('modalEmoji').style.display = 'none';
            } else {
                banner.style.display = 'none';
                document.getElementById('modalEmoji').style.display = '';
            }
            document.getElementById('modalEmoji').textContent = recipe.emoji;
            document.getElementById('modalTitle').textContent = recipe.name;
            document.getElementById('modalMeta').textContent = `${recipe.cookTime} min  ${recipe.servings} servings  ${capitalizeFirst(recipe.difficulty || 'medium')}`;
            const sourceLink = getRecipeSourceLink(recipe);
            const sourceLinkEl = document.getElementById('modalSourceLink');
            if (sourceLink) {
                sourceLinkEl.href = sourceLink;
                sourceLinkEl.style.display = 'inline-flex';
            } else {
                sourceLinkEl.removeAttribute('href');
                sourceLinkEl.style.display = 'none';
            }

            const ingredients = recipe.ingredients || [];
            const instructions = recipe.instructions || '';

            document.getElementById('modalBody').innerHTML = `
                <h3>Ingredients</h3>
                <ul>
                    ${ingredients.map(i => `<li>${escapeHtml(i.trim())}</li>`).join('')}
                </ul>
                <h3>Instructions</h3>
                <p class="instructions">${escapeHtml(instructions)}</p>
            `;

            const isLiked = likedRecipeIds.has(recipe.id);
            const canManage = canManageRecipe(recipe.id);
            document.getElementById('modalActions').innerHTML = `
                <button class="modal-btn-like" onclick="toggleLikeFromModal(${recipe.id}, this)">
                    ${isLiked ? ' Unlike' : ' Like Recipe'}
                </button>
                <button class="modal-btn-grocery" onclick="addIngredientsToGrocery(${recipe.id})">
                     Add Ingredients to List
                </button>
                ${canManage ? `<button class="modal-btn-edit" onclick="closeRecipeModal(); openEditRecipeModal(${recipe.id})"> Edit Recipe</button>` : ''}
                ${canManage ? `<button class="modal-btn-delete" onclick="deleteUserRecipe(${recipe.id})"> Delete Recipe</button>` : ''}
            `;

            document.getElementById('recipeModal').classList.add('active');
        }

        function closeRecipeModal() {
            document.getElementById('recipeModal').classList.remove('active');
        }

        async function toggleLikeFromModal(recipeId, btn) {
            try {
                if (likedRecipeIds.has(recipeId)) {
                    await TenderAPI.unlikeRecipe(recipeId);
                    likedRecipeIds.delete(recipeId);
                    applyRecipeLikeDelta(recipeId, -1);
                    btn.innerHTML = ' Like Recipe';
                } else {
                    await TenderAPI.likeRecipe(recipeId);
                    likedRecipeIds.add(recipeId);
                    applyRecipeLikeDelta(recipeId, 1);
                    btn.innerHTML = ' Unlike';
                }
            } catch (err) {
                console.error('Failed to toggle like:', err);
            }
        }

        async function addIngredientsToGrocery(recipeId) {
            const recipe = allRecipes.find(r => r.id === recipeId);
            if (!recipe || !recipe.ingredients) return;

            try {
                for (const ingredient of recipe.ingredients) {
                    await TenderAPI.addGroceryItem({ name: ingredient.trim(), quantity: 1 });
                }
                alert('Ingredients added to your grocery list!');
            } catch (err) {
                console.error('Failed to add ingredients:', err);
            }
        }

        // ==================== DELETE RECIPE ====================
        async function deleteUserRecipe(recipeId) {
            if (!confirm('Are you sure you want to delete this recipe?')) return;

            try {
                await TenderAPI.deleteRecipe(recipeId);
                myRecipeIds.delete(String(recipeId));
                closeRecipeModal();
                await loadDiscoverPage();
                await loadLikedRecipesPreview();
            } catch (err) {
                console.error('Failed to delete recipe:', err);
                alert('Failed to delete recipe. Please try again.');
            }
        }

        // ==================== EDIT RECIPE ====================
        function openEditRecipeModal(recipeId) {
            const recipe = allRecipes.find(r => r.id === recipeId);
            if (!recipe) return;

            document.getElementById('editRecipeId').value = recipe.id;
            document.getElementById('editRecipeName').value = recipe.name || '';
            document.getElementById('editRecipeDescription').value = recipe.description || '';
            document.getElementById('editRecipeEmoji').value = recipe.emoji || '';
            document.getElementById('editRecipeCookTime').value = recipe.cookTime || '';
            document.getElementById('editRecipeServings').value = recipe.servings || '';
            document.getElementById('editRecipeDifficulty').value = recipe.difficulty || 'medium';
            document.getElementById('editRecipeCuisine').value = recipe.cuisine || '';
            document.getElementById('editRecipeSourceLink').value = recipe.sourceLink || getRecipeSourceLink(recipe) || '';
            document.getElementById('editRecipeIngredients').value = (recipe.ingredients || []).join('\n');
            document.getElementById('editRecipeInstructions').value = recipe.instructions || '';

            // Set image
            if (recipe.image) {
                setImageArea('editRecipeImageArea', 'editRecipeImageData', 'editRecipeImageInput', recipe.image);
            } else {
                resetImageArea('editRecipeImageArea', 'editRecipeImageData', 'editRecipeImageInput');
            }

            document.getElementById('editRecipeModal').classList.add('active');
        }

        function closeEditRecipeModal() {
            document.getElementById('editRecipeModal').classList.remove('active');
        }

        document.getElementById('editRecipeModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditRecipeModal();
        });

        async function submitEditRecipe(e) {
            e.preventDefault();
            const btn = document.getElementById('saveRecipeBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const id = parseInt(document.getElementById('editRecipeId').value);
                const editImageVal = document.getElementById('editRecipeImageData').value;
                const sourceLinkInput = document.getElementById('editRecipeSourceLink').value.trim();
                const sourceLink = sourceLinkInput ? normalizeRecipeLink(sourceLinkInput) : null;
                if (sourceLinkInput && !sourceLink) {
                    alert('Please enter a valid URL starting with http:// or https://');
                    return;
                }
                const data = {
                    name: document.getElementById('editRecipeName').value.trim(),
                    description: document.getElementById('editRecipeDescription').value.trim(),
                    emoji: document.getElementById('editRecipeEmoji').value.trim() || undefined,
                    image: editImageVal || null,
                    sourceLink,
                    cookTime: parseInt(document.getElementById('editRecipeCookTime').value) || undefined,
                    servings: parseInt(document.getElementById('editRecipeServings').value) || undefined,
                    difficulty: document.getElementById('editRecipeDifficulty').value,
                    cuisine: document.getElementById('editRecipeCuisine').value,
                    ingredients: document.getElementById('editRecipeIngredients').value.split('\n').filter(i => i.trim()),
                    instructions: document.getElementById('editRecipeInstructions').value.trim(),
                };

                await TenderAPI.updateRecipe(id, data);
                closeEditRecipeModal();
                await loadDiscoverPage();
                await loadLikedRecipesPreview();
            } catch (err) {
                console.error('Failed to update recipe:', err);
                alert('Failed to update recipe. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        }

        // ==================== ADMIN PORTAL ====================

        let adminData = {};         // cache: { users, recipes, likes, dislikes, grocery, fridge, mealplans }
        let adminCurrentTab = 'users';
        let adminSortCol = null;
        let adminSortDir = 1;       // 1=asc, -1=desc
        let adminSwipeMode = 'all'; // 'all'|'liked'|'disliked'

        async function loadAdminPage() {
            try {
                const [stats, users, recipes, likes, dislikes, grocery, fridge, mealplans] = await Promise.all([
                    TenderAPI.adminStats().catch(() => ({})),
                    TenderAPI.getAllUsers().catch(() => []),
                    TenderAPI.adminRecipes().catch(() => []),
                    TenderAPI.adminLikes().catch(() => []),
                    TenderAPI.adminDislikes().catch(() => []),
                    TenderAPI.adminGrocery().catch(() => []),
                    TenderAPI.adminFridge().catch(() => []),
                    TenderAPI.adminMealPlans().catch(() => [])
                ]);

                // Overview stats
                document.getElementById('aStatUsers').textContent = stats.users ?? '-';
                document.getElementById('aStatRecipes').textContent = stats.recipes ?? '-';
                document.getElementById('aStatLikes').textContent = stats.likes ?? '-';
                document.getElementById('aStatDislikes').textContent = stats.dislikes ?? '-';
                document.getElementById('aStatGrocery').textContent = stats.grocery ?? '-';
                document.getElementById('aStatFridge').textContent = stats.fridge ?? '-';
                document.getElementById('aStatMealPlans').textContent = stats.mealplans ?? '-';
                document.getElementById('aStatDbSize').textContent = stats.dbSize != null ? formatBytes(stats.dbSize) : '-';

                // Combine likes and dislikes into swipes
                const liked = (likes || []).map(r => ({ ...r, swipe_type: 'liked', swipe_date: r.liked_at }));
                const disliked = (dislikes || []).map(r => ({ ...r, swipe_type: 'disliked', swipe_date: r.disliked_at }));

                adminData = {
                    users: users || [],
                    recipes: recipes || [],
                    swipes: [...liked, ...disliked].sort((a, b) => (b.swipe_date || '').localeCompare(a.swipe_date || '')),
                    grocery: grocery || [],
                    fridge: fridge || [],
                    mealplans: mealplans || []
                };

                renderAdminTable(adminCurrentTab);
            } catch (err) {
                console.error('Admin page load error:', err);
            }
        }

        function switchAdminTab(tab) {
            adminCurrentTab = tab;
            adminSortCol = null;
            adminSortDir = 1;
            document.getElementById('adminSearchInput').value = '';
            document.querySelectorAll('.admin-subtab-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.tab === tab);
            });
            // Show swipe filter only on swipes tab
            document.getElementById('adminSwipeFilter').style.display = tab === 'swipes' ? 'flex' : 'none';
            if (tab === 'swipes') adminSwipeMode = 'all';
            renderAdminTable(tab);
        }

        function adminSwipeFilterSet(mode, btn) {
            adminSwipeMode = mode;
            document.querySelectorAll('#adminSwipeFilter button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderAdminTable('swipes');
        }

        function getAdminRows(tab) {
            switch (tab) {
                case 'users': return adminData.users || [];
                case 'recipes': return adminData.recipes || [];
                case 'swipes': {
                    const all = adminData.swipes || [];
                    if (adminSwipeMode === 'liked') return all.filter(r => r.swipe_type === 'liked');
                    if (adminSwipeMode === 'disliked') return all.filter(r => r.swipe_type === 'disliked');
                    return all;
                }
                case 'grocery': return adminData.grocery || [];
                case 'fridge': return adminData.fridge || [];
                case 'mealplans': return adminData.mealplans || [];
                default: return [];
            }
        }

        function getAdminColumns(tab) {
            switch (tab) {
                case 'users':    return ['id', 'firstName', 'lastName', 'email', 'isAdmin', 'cookingSkill', 'householdSize', 'weeklyBudget', 'createdAt'];
                case 'recipes':  return ['id', 'name', 'cuisine', 'difficulty', 'cook_time', 'servings', 'created_by_email', 'created_at'];
                case 'swipes':   return ['user_email', 'recipe_name', 'swipe_type', 'swipe_date'];
                case 'grocery':  return ['user_email', 'name', 'quantity', 'unit', 'category', 'checked', 'added_at'];
                case 'fridge':   return ['user_email', 'name', 'quantity', 'unit', 'category', 'added_at'];
                case 'mealplans':return ['user_email', 'recipe_name', 'plan_date', 'meal_type'];
                default: return [];
            }
        }

        function getAdminHeaders(tab) {
            switch (tab) {
                case 'users':    return ['ID', 'First Name', 'Last Name', 'Email', 'Admin', 'Skill', 'Household', 'Budget', 'Joined'];
                case 'recipes':  return ['ID', 'Name', 'Cuisine', 'Difficulty', 'Cook Time', 'Servings', 'Created By', 'Created At'];
                case 'swipes':   return ['User Email', 'Recipe', 'Type', 'Date'];
                case 'grocery':  return ['User Email', 'Item', 'Qty', 'Unit', 'Category', 'Checked', 'Added At'];
                case 'fridge':   return ['User Email', 'Item', 'Qty', 'Unit', 'Category', 'Added At'];
                case 'mealplans':return ['User Email', 'Recipe', 'Date', 'Meal Type'];
                default: return [];
            }
        }

        function renderAdminTable(tab, rows) {
            const cols = getAdminColumns(tab);
            const headers = getAdminHeaders(tab);
            const allRows = rows !== undefined ? rows : getAdminRows(tab);

            // Apply search filter
            const query = (document.getElementById('adminSearchInput')?.value || '').toLowerCase();
            const filtered = query
                ? allRows.filter(r => cols.some(c => String(r[c] ?? '').toLowerCase().includes(query)))
                : allRows;

            // Apply sort
            const sorted = adminSortCol !== null ? [...filtered].sort((a, b) => {
                const va = String(a[cols[adminSortCol]] ?? '');
                const vb = String(b[cols[adminSortCol]] ?? '');
                return va.localeCompare(vb, undefined, { numeric: true }) * adminSortDir;
            }) : filtered;

            // Render header
            const thead = document.getElementById('adminTableHead');
            thead.innerHTML = '<tr>' + headers.map((h, i) => {
                let cls = '';
                if (adminSortCol === i) cls = adminSortDir === 1 ? 'sorted-asc' : 'sorted-desc';
                return `<th class="${cls}" onclick="sortAdminTable(${i})">${h}</th>`;
            }).join('') + (tab === 'users' ? '<th>Action</th>' : '') + '</tr>';

            // Render body
            const tbody = document.getElementById('adminTableBody');
            if (sorted.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${cols.length + (tab === 'users' ? 1 : 0)}" style="text-align:center;color:var(--text-secondary);padding:24px;">No data found.</td></tr>`;
            } else {
                tbody.innerHTML = sorted.map(row => {
                    const cells = cols.map(c => {
                        let val = row[c];
                        if (tab === 'users' && c === 'isAdmin') {
                            val = val ? '<span class="admin-badge-yes">Admin</span>' : '<span class="admin-badge-no">User</span>';
                        } else if (tab === 'swipes' && c === 'swipe_type') {
                            val = val === 'liked'
                                ? '<span class="admin-type-liked">Liked</span>'
                                : '<span class="admin-type-disliked">Disliked</span>';
                        } else if (tab === 'grocery' && c === 'checked') {
                            val = val ? '' : '';
                        } else if (c === 'cook_time' && val != null) {
                            val = val + ' min';
                        } else if ((c.endsWith('_at') || c === 'plan_date' || c === 'swipe_date') && val) {
                            val = new Date(val).toLocaleDateString();
                        } else if (c === 'createdAt' && val) {
                            val = new Date(val).toLocaleDateString();
                        } else {
                            val = escapeHtml(String(val ?? ''));
                        }
                        return `<td>${val}</td>`;
                    });
                    let actionCell = '';
                    if (tab === 'users') {
                        const isAdm = row.isAdmin;
                        if (isAdm) {
                            actionCell = `<td><button class="admin-demote-btn" onclick="adminDemoteUser('${escapeHtml(row.email)}')">Demote</button></td>`;
                        } else {
                            actionCell = `<td><button class="admin-promote-btn" onclick="adminPromoteUser('${escapeHtml(row.email)}')">Promote</button></td>`;
                        }
                    }
                    return '<tr>' + cells.join('') + actionCell + '</tr>';
                }).join('');
            }

            document.getElementById('adminRowBadge').textContent = `${sorted.length} row${sorted.length !== 1 ? 's' : ''}`;
        }

        function adminSearch(query) {
            renderAdminTable(adminCurrentTab);
        }

        function sortAdminTable(colIndex) {
            if (adminSortCol === colIndex) {
                adminSortDir *= -1;
            } else {
                adminSortCol = colIndex;
                adminSortDir = 1;
            }
            renderAdminTable(adminCurrentTab);
        }

        async function adminPromoteUser(email) {
            try {
                await TenderAPI.promoteToAdmin(email);
                // Update cached user data
                const u = adminData.users.find(u => u.email === email);
                if (u) u.isAdmin = true;
                renderAdminTable('users');
                // Update stat
                const statsEl = document.getElementById('aStatUsers');
                // no count change, just re-render
            } catch (err) {
                alert(err.message || 'Failed to promote user.');
            }
        }

        async function adminDemoteUser(email) {
            try {
                await TenderAPI.demoteAdmin(email);
                const u = adminData.users.find(u => u.email === email);
                if (u) u.isAdmin = false;
                renderAdminTable('users');
            } catch (err) {
                alert(err.message || 'Failed to demote user.');
            }
        }

        // ==================== DB DUMP VIEWER ====================

        let dbDumpRawText = '';
        let dbDumpLastSearch = '';

        async function openDbDump() {
            const btn = document.querySelector('.db-dump-btn');
            const original = btn ? btn.textContent : '';
            if (btn) { btn.textContent = ' Loading'; btn.disabled = true; }

            try {
                const [data, stats] = await Promise.all([
                    TenderAPI.adminDump(),
                    TenderAPI.adminStats().catch(() => ({}))
                ]);
                const dbSize = stats.dbSize ?? null;
                const rawText = formatDbDump(data, dbSize);

                const escaped = rawText
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                const html = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>tender.db dump</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #1e1e1e; color: #d4d4d4; }
  pre { font-family: Consolas, 'Courier New', monospace; font-size: 13px;
        line-height: 1.6; padding: 24px; white-space: pre;
        overflow-x: auto; min-width: max-content; }
</style></head>
<body><pre>${escaped}</pre></body></html>`;
                const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                setTimeout(() => URL.revokeObjectURL(url), 30000);
            } catch (err) {
                alert('Failed to load database dump: ' + (err.message || 'Unknown error'));
            } finally {
                if (btn) { btn.textContent = original; btn.disabled = false; }
            }
        }

        function closeDbDump() {
            document.getElementById('dbDumpOverlay').classList.remove('active');
        }

        function handleDumpOverlayClick(e) {
            if (e.target === document.getElementById('dbDumpOverlay')) closeDbDump();
        }

        function formatBytes(bytes) {
            if (bytes == null) return '?';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function formatDbDump(data, dbSize) {
            const ts = new Date().toLocaleString();
            const LINE = ''.repeat(72);
            let out = '';
            out += `-- ============================================================\n`;
            out += `-- TENDER DATABASE DUMP\n`;
            out += `-- Generated: ${ts}\n`;
            if (dbSize != null) out += `-- File size: ${formatBytes(dbSize)} (${dbSize.toLocaleString()} bytes)\n`;
            out += `-- ============================================================\n\n`;

            for (const [tableName, rows] of Object.entries(data)) {
                out += `${LINE}\n`;
                out += `TABLE: ${tableName.toUpperCase()}  (${rows.length} row${rows.length !== 1 ? 's' : ''})\n`;
                out += `${LINE}\n`;

                if (rows.length === 0) {
                    out += `(empty)\n\n`;
                    continue;
                }

                const cols = Object.keys(rows[0]);
                // Calculate column widths: max of header or value, capped at 36
                const widths = cols.map(c =>
                    Math.min(36, Math.max(c.length, ...rows.map(r => String(r[c] ?? 'NULL').length)))
                );

                // Header row
                out += cols.map((c, i) => c.padEnd(widths[i])).join('  ') + '\n';
                out += cols.map((c, i) => ''.repeat(widths[i])).join('  ') + '\n';

                // Data rows
                for (const row of rows) {
                    out += cols.map((c, i) => {
                        let val = row[c] == null ? 'NULL' : String(row[c]);
                        // Truncate long values
                        if (val.length > widths[i]) val = val.slice(0, widths[i] - 1) + '';
                        return val.padEnd(widths[i]);
                    }).join('  ') + '\n';
                }
                out += '\n';
            }

            return out;
        }

        function syntaxColorDump(text) {
            // Escape HTML first, then apply colour spans
            let escaped = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Comments (lines starting with --)
            escaped = escaped.replace(/^(-- .+)$/gm, '<span class="dump-comment">$1</span>');

            // TABLE: headers
            escaped = escaped.replace(/^(TABLE: \S+.*)$/gm, '<span class="dump-table">$1</span>');

            // Divider lines
            escaped = escaped.replace(/^(+)$/gm, '<span class="dump-divider">$1</span>');

            // NULL values
            escaped = escaped.replace(/\bNULL\b/g, '<span class="dump-null">NULL</span>');

            return escaped;
        }

        function highlightDumpSearch(query) {
            dbDumpLastSearch = query;
            renderDumpPre(dbDumpRawText, query);

            // Update info with match count
            if (query && dbDumpRawText) {
                const matches = (dbDumpRawText.match(new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi')) || []).length;
                const info = document.getElementById('dbDumpInfo');
                const base = info.textContent.split('  match')[0];
                info.textContent = matches > 0
                    ? `${base}  ${matches} match${matches !== 1 ? 'es' : ''}`
                    : `${base}  no matches`;
            }
        }

        function renderDumpPre(rawText, searchQuery) {
            let html = syntaxColorDump(rawText);

            if (searchQuery && searchQuery.length > 0) {
                // Highlight search term (applied after syntax coloring, so we match visible text)
                const safeQ = searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                // We need to highlight only in text nodes, not inside span tags
                // Simple approach: highlight the escaped version of the query
                const escapedQ = searchQuery
                    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeEscQ = escapedQ.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                html = html.replace(new RegExp(`(${safeEscQ})`, 'gi'),
                    '<mark style="background:#613214;color:#ffd700;border-radius:2px;">$1</mark>');
            }

            document.getElementById('dbDumpPre').innerHTML = html;
        }

        function copyDbDump() {
            if (!dbDumpRawText) return;
            navigator.clipboard.writeText(dbDumpRawText).then(() => {
                const btn = document.querySelector('.db-dump-copy-btn');
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = 'Copy All'; }, 1800);
            }).catch(() => {
                // Fallback for non-secure contexts
                const ta = document.createElement('textarea');
                ta.value = dbDumpRawText;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            });
        }

        // ==================== MEAL PLAN PAGE ====================
        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setDate(diff);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function formatDate(d) {
            return d.toISOString().split('T')[0];
        }

        function formatDateShort(d) {
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const mealTypes = ['breakfast', 'lunch', 'dinner'];

        function getMealsForSlot(entries, dateStr, mealType) {
            return entries
                .filter(m => m.plan_date === dateStr && m.meal_type === mealType)
                .sort((a, b) => {
                    const courseRankA = a.course === 'main' ? 0 : 1;
                    const courseRankB = b.course === 'main' ? 0 : 1;
                    if (courseRankA !== courseRankB) return courseRankA - courseRankB;
                    const posA = Number(a.position || 0);
                    const posB = Number(b.position || 0);
                    if (posA !== posB) return posA - posB;
                    return Number(a.id || 0) - Number(b.id || 0);
                });
        }

        function initMealPlanDragDrop() {
            if (mealPlanDragBound) return;
            const container = document.getElementById('mealplanWeek');
            if (!container) return;

            mealPlanDragBound = true;
            container.addEventListener('dragstart', onMealSlotDragStart);
            container.addEventListener('dragover', onMealSlotDragOver);
            container.addEventListener('drop', onMealSlotDrop);
            container.addEventListener('dragleave', onMealSlotDragLeave);
            container.addEventListener('dragend', onMealSlotDragEnd);
            document.addEventListener('dragover', onMealSlotGlobalDragOver);
        }

        function updateMealSlotGhostPosition(x, y) {
            if (!mealPlanDragState.ghostEl) return;
            mealPlanDragState.ghostEl.style.left = `${x}px`;
            mealPlanDragState.ghostEl.style.top = `${y}px`;
        }

        function destroyMealSlotGhost() {
            if (mealPlanDragState.ghostEl) {
                mealPlanDragState.ghostEl.remove();
                mealPlanDragState.ghostEl = null;
            }
        }

        function clearMealSlotDropTarget() {
            if (mealPlanDragState.dropEl) {
                mealPlanDragState.dropEl.classList.remove('drop-target');
                mealPlanDragState.dropEl = null;
            }
        }

        function resetMealSlotDragState() {
            if (mealPlanDragState.sourceEl) {
                mealPlanDragState.sourceEl.classList.remove('drag-origin');
            }
            clearMealSlotDropTarget();
            destroyMealSlotGhost();
            mealPlanDragState.active = false;
            mealPlanDragState.sourceDate = null;
            mealPlanDragState.sourceMealType = null;
            mealPlanDragState.sourceEl = null;
            mealPlanDragState.moving = false;
        }

        function onMealSlotGlobalDragOver(event) {
            if (!mealPlanDragState.active) return;
            updateMealSlotGhostPosition(event.clientX, event.clientY);
        }

        function onMealSlotDragStart(event) {
            const slotEl = event.target.closest('.meal-slot.planned-slot[draggable="true"]');
            if (!slotEl || mealPlanDragState.moving) {
                event.preventDefault();
                return;
            }
            if (event.target.closest('.remove-meal, .meal-slot-add-side')) {
                event.preventDefault();
                return;
            }

            mealPlanDragState.active = true;
            mealPlanDragState.sourceDate = slotEl.dataset.date;
            mealPlanDragState.sourceMealType = slotEl.dataset.meal;
            mealPlanDragState.sourceEl = slotEl;
            slotEl.classList.add('drag-origin');

            const blankImg = new Image();
            blankImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
            event.dataTransfer.setDragImage(blankImg, 0, 0);
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', `${mealPlanDragState.sourceDate}|${mealPlanDragState.sourceMealType}`);

            const ghost = slotEl.cloneNode(true);
            ghost.classList.add('meal-slot-drag-ghost');
            ghost.style.width = `${Math.round(slotEl.getBoundingClientRect().width)}px`;
            document.body.appendChild(ghost);
            mealPlanDragState.ghostEl = ghost;
            updateMealSlotGhostPosition(event.clientX, event.clientY);
        }

        function onMealSlotDragOver(event) {
            if (!mealPlanDragState.active) return;
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            updateMealSlotGhostPosition(event.clientX, event.clientY);

            const targetSlot = event.target.closest('.meal-slot.open-slot');
            if (targetSlot !== mealPlanDragState.dropEl) {
                clearMealSlotDropTarget();
                if (targetSlot) {
                    targetSlot.classList.add('drop-target');
                    mealPlanDragState.dropEl = targetSlot;
                }
            }
        }

        function onMealSlotDragLeave(event) {
            if (!mealPlanDragState.active || !mealPlanDragState.dropEl) return;
            const leavingCurrentTarget = event.target === mealPlanDragState.dropEl;
            if (leavingCurrentTarget && !mealPlanDragState.dropEl.contains(event.relatedTarget)) {
                clearMealSlotDropTarget();
            }
        }

        async function movePlannedMealSlot(fromDate, fromMealType, toDate, toMealType) {
            if (!fromDate || !fromMealType || !toDate || !toMealType) return;
            try {
                await TenderAPI.moveMealPlanSlot(fromDate, fromMealType, toDate, toMealType);
                mealPlanLastMovedTarget = `${toDate}|${toMealType}`;
                await loadMealPlanPage();
                setTimeout(() => {
                    mealPlanLastMovedTarget = null;
                }, 350);
            } catch (err) {
                console.error('Failed to move meal slot:', err);
                alert(err?.message || 'Could not move that meal slot.');
            }
        }

        function onMealSlotDrop(event) {
            if (!mealPlanDragState.active || mealPlanDragState.moving) return;
            event.preventDefault();

            const dropEl = event.target.closest('.meal-slot.open-slot');
            const sourceDate = mealPlanDragState.sourceDate;
            const sourceMealType = mealPlanDragState.sourceMealType;
            const toDate = dropEl?.dataset?.date;
            const toMealType = dropEl?.dataset?.meal;

            if (!dropEl || !toDate || !toMealType) return;
            mealPlanDragState.moving = true;
            movePlannedMealSlot(sourceDate, sourceMealType, toDate, toMealType)
                .finally(() => {
                    resetMealSlotDragState();
                });
        }

        function onMealSlotDragEnd() {
            if (!mealPlanDragState.moving) {
                resetMealSlotDragState();
            }
        }

        function changeWeek(offset) {
            currentWeekStart = new Date(currentWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + (offset * 7));
            clearDaySelection();
            loadMealPlanPage();
        }

        async function loadMealPlanPage() {
            initMealPlanDragDrop();

            // Ensure we have recipes loaded
            if (allRecipes.length === 0) {
                try {
                    allRecipes = await TenderAPI.getRecipes();
                } catch (err) {
                    console.error('Failed to load recipes:', err);
                }
            }

            // Update week label
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekLabel').textContent =
                `${formatDateShort(currentWeekStart)} - ${formatDateShort(weekEnd)}`;

            // Load meal plan data
            try {
                mealPlanData = await TenderAPI.getMealPlan();
            } catch (err) {
                console.error('Failed to load meal plan:', err);
                mealPlanData = [];
            }

            renderMealPlanWeek();
            updateMealPlanSummary();
        }

        function renderMealPlanWeek() {
            const container = document.getElementById('mealplanWeek');
            const today = formatDate(new Date());

            function buildWeekGrid(weekStart, label) {
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                let html = `
                    <div class="week-section-label">
                        <span>${label}</span>
                        <span class="week-section-range">${formatDateShort(weekStart)}  ${formatDateShort(weekEnd)}</span>
                    </div>
                    <div class="mealplan-week">
                `;

                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(date.getDate() + i);
                    const dateStr = formatDate(date);
                    const isToday = dateStr === today;
                    const isGroceryDay = groceryDay === dateStr;
                    const groceryTitle = isGroceryDay ? 'Clear grocery day' : 'Set as grocery shopping day';
                    const groceryLabel = isGroceryDay ? ' Grocery Day' : ' Set Grocery Day';

                    html += `
                        <div class="mealplan-day ${isToday ? 'today' : ''} ${isGroceryDay ? 'grocery-day' : ''}" data-date="${dateStr}">
                            <div class="mealplan-day-header" onclick="toggleDaySelection('${dateStr}')">
                                ${dayNames[i]}
                                <div class="date">${formatDateShort(date)}</div>
                                <button class="grocery-day-btn" onclick="event.stopPropagation();toggleGroceryDay('${dateStr}')" title="${groceryTitle}">${groceryLabel}</button>
                                <span class="select-check"></span>
                            </div>
                    `;

                    for (const meal of mealTypes) {
                        const slotMeals = getMealsForSlot(mealPlanData, dateStr, meal);
                        const slotKey = `${dateStr}|${meal}`;
                        const slotClass = `meal-slot ${slotMeals.length > 0 ? 'planned-slot' : 'open-slot'}${mealPlanLastMovedTarget === slotKey ? ' slot-snap' : ''}`;
                        const draggableAttr = slotMeals.length > 0 ? 'draggable="true"' : '';

                        html += `
                            <div class="${slotClass}" data-date="${dateStr}" data-meal="${meal}" ${draggableAttr}>
                                <div class="meal-slot-header">
                                    <div class="meal-slot-label">${capitalizeFirst(meal)}</div>
                                    ${slotMeals.length > 0
                                        ? `<button class="meal-slot-add-side" onclick="openAddMealModal('${dateStr}', '${meal}', 'secondary')" title="Add another dish to ${capitalizeFirst(meal)}" aria-label="Add another dish to ${capitalizeFirst(meal)}">+</button>`
                                        : ''
                                    }
                                </div>
                        `;

                        if (slotMeals.length > 0) {
                            html += slotMeals.map(item => `
                                <div class="meal-slot-content ${item.course === 'secondary' ? 'meal-slot-side-content' : ''}">
                                    <button class="meal-recipe-btn" onclick="openRecipeModal(${item.recipe_id})" title="View recipe details">
                                        ${item.course === 'secondary' ? '<span class="meal-side-tag">side</span>' : ''}
                                        <span class="meal-emoji">${item.recipe_emoji || '&#127869;'}</span>
                                        <span class="meal-name">${escapeHtml(item.recipe_name)}</span>
                                    </button>
                                    <button class="remove-meal" onclick="removeMeal(${item.id})">&times;</button>
                                </div>
                            `).join('');
                        } else {
                            html += `
                                <div class="meal-slot-empty">
                                    <button class="add-meal-btn" onclick="openAddMealModal('${dateStr}', '${meal}')">+ Add ${capitalizeFirst(meal)}</button>
                                </div>
                            `;
                        }

                        html += `</div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                return html;
            }

            const nextWeekStart = new Date(currentWeekStart);
            nextWeekStart.setDate(nextWeekStart.getDate() + 7);

            container.innerHTML =
                buildWeekGrid(currentWeekStart, 'This Week') +
                buildWeekGrid(nextWeekStart, 'Next Week');
        }

        function updateMealPlanSummary() {
            // Filter to current week
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const startStr = formatDate(currentWeekStart);
            const endStr = formatDate(weekEnd);

            const weekMeals = mealPlanData.filter(m =>
                m.plan_date >= startStr && m.plan_date <= endStr
            );

            document.getElementById('summaryMeals').textContent = weekMeals.length;

            const uniqueRecipes = new Set();
            weekMeals.forEach(m => {
                if (m.recipe_id) uniqueRecipes.add(m.recipe_id);
            });
            document.getElementById('summaryRecipes').textContent = uniqueRecipes.size;

            // Estimate cook time from recipes
            let totalTime = 0;
            weekMeals.forEach(m => {
                const recipe = allRecipes.find(r => r.id === m.recipe_id || r.name === m.recipe_name);
                if (recipe) totalTime += recipe.cookTime || 0;
            });
            document.getElementById('summaryCookTime').textContent = totalTime + ' min';
        }

        // ==================== DAY SELECTION & ADD INGREDIENTS ====================
        let selectedDays = new Set();

        function toggleDaySelection(dateStr) {
            const dayEl = document.querySelector(`.mealplan-day[data-date="${dateStr}"]`);
            if (!dayEl) return;

            if (selectedDays.has(dateStr)) {
                selectedDays.delete(dateStr);
                dayEl.classList.remove('selected');
            } else {
                selectedDays.add(dateStr);
                dayEl.classList.add('selected');
            }

            updateIngredientBar();
        }

        function clearDaySelection() {
            selectedDays.clear();
            document.querySelectorAll('.mealplan-day.selected').forEach(el => el.classList.remove('selected'));
            updateIngredientBar();
        }

        function updateIngredientBar() {
            const bar = document.getElementById('ingredientBar');

            if (selectedDays.size === 0) {
                bar.classList.remove('visible');
                return;
            }

            // Gather all meals from selected days
            const selectedMeals = mealPlanData.filter(m => selectedDays.has(m.plan_date));
            const mealCount = selectedMeals.length;

            // Count total ingredients
            let totalIngredients = 0;
            selectedMeals.forEach(m => {
                const recipe = allRecipes.find(r => r.id === m.recipe_id || r.name === m.recipe_name);
                if (recipe && recipe.ingredients) {
                    totalIngredients += recipe.ingredients.length;
                }
            });

            const dayCount = selectedDays.size;
            document.getElementById('ingredientBarTitle').textContent =
                `${dayCount} day${dayCount !== 1 ? 's' : ''} selected`;
            document.getElementById('ingredientBarSubtitle').textContent =
                `${mealCount} meal${mealCount !== 1 ? 's' : ''}  ${totalIngredients} ingredient${totalIngredients !== 1 ? 's' : ''}`;

            bar.classList.add('visible');
        }

        async function addSelectedIngredientsToGrocery() {
            const selectedMeals = mealPlanData.filter(m => selectedDays.has(m.plan_date));

            if (selectedMeals.length === 0) {
                alert('No meals planned on the selected days.');
                return;
            }

            // Collect all ingredients and consolidate duplicates client-side
            const ingredientMap = new Map(); // lowercase name -> { name, quantity }
            selectedMeals.forEach(m => {
                const addIngredients = recipe => {
                    if (!recipe || !recipe.ingredients) return;
                    recipe.ingredients.forEach(ing => {
                        const name = ing.trim();
                        if (!name) return;
                        const key = name.toLowerCase();
                        if (ingredientMap.has(key)) {
                            ingredientMap.get(key).quantity++;
                        } else {
                            ingredientMap.set(key, { name, quantity: 1 });
                        }
                    });
                };
                addIngredients(allRecipes.find(r => r.id === m.recipe_id || r.name === m.recipe_name));
            });

            const consolidated = Array.from(ingredientMap.values());

            if (consolidated.length === 0) {
                alert('No ingredients found for the selected meals.');
                return;
            }

            // Add each unique ingredient to the grocery list (server also deduplicates)
            const btn = document.querySelector('.btn-add-ingredients');
            btn.disabled = true;
            btn.textContent = 'Adding...';

            let added = 0;
            try {
                for (const item of consolidated) {
                    await TenderAPI.addGroceryItem({ name: item.name, quantity: item.quantity });
                    added++;
                }
                alert(`Added ${added} ingredient${added !== 1 ? 's' : ''} to your grocery list!`);
                clearDaySelection();
            } catch (err) {
                console.error('Failed to add ingredients:', err);
                alert(`Added ${added} ingredients before an error occurred.`);
            } finally {
                btn.disabled = false;
                btn.textContent = ' Add All Ingredients';
            }
        }
        function setAddMealRecipeFilter(mode) {
            addMealFilterMode = mode === 'all' ? 'all' : 'liked';

            const likedBtn = document.getElementById('addMealFilterLiked');
            const allBtn = document.getElementById('addMealFilterAll');
            if (likedBtn && allBtn) {
                likedBtn.classList.toggle('active', addMealFilterMode === 'liked');
                allBtn.classList.toggle('active', addMealFilterMode === 'all');
            }

            renderAddMealRecipeList();
        }

        function renderAddMealRecipeList() {
            const list = document.getElementById('recipeSelectList');
            if (!list) return;

            const sourceRecipes = addMealFilterMode === 'liked' ? addMealLikedRecipes : allRecipes;
            let recipes = Array.isArray(sourceRecipes) ? sourceRecipes : [];

            if (addMealSearchQuery.trim()) {
                const q = addMealSearchQuery.toLowerCase();
                recipes = recipes.filter(r =>
                    r.name.toLowerCase().includes(q) ||
                    (r.cuisine && r.cuisine.toLowerCase().includes(q)) ||
                    (r.ingredients && (Array.isArray(r.ingredients) ? r.ingredients.join(', ') : r.ingredients).toLowerCase().includes(q))
                );
            }

            if (recipes.length === 0) {
                const emptyMsg = addMealSearchQuery.trim()
                    ? 'No recipes match your search.'
                    : addMealFilterMode === 'liked'
                        ? 'Please like recipes to see them here.'
                        : 'No recipes available right now.';
                list.innerHTML = `<div class="recipe-select-empty">${emptyMsg}</div>`;
                return;
            }

            list.innerHTML = recipes.map(recipe => `
                <div class="recipe-select-item" onclick="selectMealRecipe(${recipe.id})">
                    <span class="recipe-select-emoji">${recipe.emoji || '&#127869;'}</span>
                    <div class="recipe-select-info">
                        <div class="name">${escapeHtml(recipe.name)}</div>
                        <div class="time">
                            <span>${recipe.cookTime || '?'} min</span>
                            <span class="rsi-dot"></span>
                            <span>${capitalizeFirst(recipe.difficulty || 'medium')}</span>
                            ${recipe.cuisine ? `<span class="rsi-dot"></span><span class="rsi-cuisine">${capitalizeFirst(recipe.cuisine)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function openAddMealModal(date, mealType, course = 'main') {
            pendingMealSlot = { date, mealType, course };
            const dateFormatted = new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            document.getElementById('addMealTitle').textContent = course === 'secondary'
                ? `Add Another Dish for ${capitalizeFirst(mealType)} on ${dateFormatted}`
                : `Add ${capitalizeFirst(mealType)} for ${dateFormatted}`;

            // Clear search state
            addMealSearchQuery = '';
            const searchInput = document.getElementById('addMealSearch');
            if (searchInput) searchInput.value = '';
            const clearBtn = document.getElementById('addMealSearchClear');
            if (clearBtn) clearBtn.classList.remove('visible');

            // Ensure recipe pools are ready, then default picker to liked recipes.
            if (allRecipes.length === 0) {
                try {
                    allRecipes = await TenderAPI.getRecipes();
                } catch (err) {
                    console.error('Failed to load recipes for meal picker:', err);
                    allRecipes = [];
                }
            }
            try {
                addMealLikedRecipes = await TenderAPI.getLikedRecipes();
            } catch (err) {
                console.error('Failed to load liked recipes for meal picker:', err);
                addMealLikedRecipes = [];
            }

            setAddMealRecipeFilter('all');
            document.getElementById('addMealModal').classList.add('active');
        }

        function closeAddMealModal() {
            document.getElementById('addMealModal').classList.remove('active');
            pendingMealSlot = null;
        }

        function onAddMealSearch(value) {
            addMealSearchQuery = value;
            const clearBtn = document.getElementById('addMealSearchClear');
            if (clearBtn) clearBtn.classList.toggle('visible', value.length > 0);
            renderAddMealRecipeList();
        }

        function clearAddMealSearch() {
            addMealSearchQuery = '';
            const input = document.getElementById('addMealSearch');
            if (input) input.value = '';
            const clearBtn = document.getElementById('addMealSearchClear');
            if (clearBtn) clearBtn.classList.remove('visible');
            renderAddMealRecipeList();
        }

        function toggleGroceryDay(dateStr) {
            if (groceryDay === dateStr) {
                groceryDay = null;
                localStorage.removeItem('tenderGroceryDay');
            } else {
                groceryDay = dateStr;
                localStorage.setItem('tenderGroceryDay', dateStr);
            }
            renderMealPlanWeek();
        }

        async function selectMealRecipe(recipeId) {
            if (!pendingMealSlot) return;

            try {
                await TenderAPI.addToMealPlan(
                    recipeId,
                    pendingMealSlot.date,
                    pendingMealSlot.mealType,
                    pendingMealSlot.course || 'main'
                );
                closeAddMealModal();
                loadMealPlanPage();
            } catch (err) {
                console.error('Failed to add to meal plan:', err);
            }
        }

        async function removeMeal(itemId) {
            try {
                await TenderAPI.removeMealPlanItem(itemId);
                loadMealPlanPage();
            } catch (err) {
                console.error('Failed to remove meal:', err);
            }
        }

        async function quickAddToMealPlan(recipeId) {
            // Add to today's next available meal slot
            const today = formatDate(new Date());
            for (const meal of mealTypes) {
                const existing = mealPlanData.find(m => m.plan_date === today && m.meal_type === meal);
                if (!existing) {
                    try {
                        await TenderAPI.addToMealPlan(recipeId, today, meal);
                        alert(`Added to today's ${meal}!`);
                        return;
                    } catch (err) {
                        console.error('Failed to add to meal plan:', err);
                        return;
                    }
                }
            }
            // If all slots filled, open the modal to pick a day
            openAddMealModal(today, 'dinner');
        }

        // ==================== GROCERY PAGE ====================
        async function loadGroceryPage() {
            try {
                const items = await TenderAPI.getGroceryList();
                renderGroceryPage(items);
            } catch (err) {
                console.error('Failed to load grocery list:', err);
            }
        }

        function renderGroceryPage(items) {
            // Stats
            const total = items.length;
            const checked = items.filter(i => i.checked).length;
            document.getElementById('groceryTotalItems').textContent = total;
            document.getElementById('groceryCheckedItems').textContent = checked;
            document.getElementById('groceryRemainingItems').textContent = total - checked;

            const container = document.getElementById('groceryFullList');

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 60px 20px;">
                        <div class="icon"></div>
                        <p>Your grocery list is empty.<br>Add items above or add ingredients from a recipe!</p>
                    </div>
                `;
                return;
            }

            // Sort: unchecked first, then checked
            const sorted = [...items].sort((a, b) => a.checked - b.checked);

            container.innerHTML = sorted.map(item => `
                <div class="grocery-full-item ${item.checked ? 'checked' : ''}">
                    <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleGroceryItemFull(${item.id})">
                    <span class="item-name">${escapeHtml(item.name)}</span>
                    ${item.quantity > 1 ? `<span class="item-quantity">x${item.quantity}</span>` : ''}
                    <button class="item-delete" onclick="deleteGroceryItemFull(${item.id})"></button>
                </div>
            `).join('');
        }

        async function addGroceryItemFull(e) {
            e.preventDefault();
            const nameInput = document.getElementById('newGroceryName');
            const qtyInput = document.getElementById('newGroceryQty');
            const name = nameInput.value.trim();
            const quantity = parseInt(qtyInput.value) || 1;

            if (!name) return;

            try {
                await TenderAPI.addGroceryItem({ name, quantity });
                nameInput.value = '';
                qtyInput.value = '1';
                loadGroceryPage();
            } catch (err) {
                console.error('Failed to add item:', err);
            }
        }

        async function toggleGroceryItemFull(itemId) {
            try {
                await TenderAPI.toggleGroceryItem(itemId);
                loadGroceryPage();
            } catch (err) {
                console.error('Failed to toggle item:', err);
            }
        }

        async function deleteGroceryItemFull(itemId) {
            try {
                await TenderAPI.deleteGroceryItem(itemId);
                loadGroceryPage();
            } catch (err) {
                console.error('Failed to delete item:', err);
            }
        }

        function showConfirm({ icon, title, message, confirmText }) {
            return new Promise(resolve => {
                document.getElementById('confirmIcon').textContent = icon || '';
                document.getElementById('confirmTitle').textContent = title || 'Are you sure?';
                document.getElementById('confirmMessage').textContent = message || '';
                document.getElementById('confirmOk').textContent = confirmText || 'Confirm';
                document.getElementById('confirmDialog').classList.add('active');

                const okBtn = document.getElementById('confirmOk');
                const cancelBtn = document.getElementById('confirmCancel');
                const overlay = document.getElementById('confirmDialog');

                function cleanup(result) {
                    overlay.classList.remove('active');
                    okBtn.replaceWith(okBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                    overlay.removeEventListener('click', onOverlay);
                    resolve(result);
                }
                function onOverlay(e) { if (e.target === overlay) cleanup(false); }

                document.getElementById('confirmOk').addEventListener('click', () => cleanup(true));
                document.getElementById('confirmCancel').addEventListener('click', () => cleanup(false));
                overlay.addEventListener('click', onOverlay);
            });
        }

        async function clearFullGroceryList() {
            const ok = await showConfirm({
                icon: '',
                title: 'Clear Grocery List?',
                message: 'This will remove all items from your grocery list. This action cannot be undone.',
                confirmText: 'Clear All'
            });
            if (ok) {
                try {
                    await TenderAPI.clearGroceryList();
                    loadGroceryPage();
                } catch (err) {
                    console.error('Failed to clear list:', err);
                }
            }
        }

        // ==================== GROCERY/FRIDGE TABS ====================
        let currentGroceryTab = 'grocery';

        function switchGroceryTab(tab) {
            currentGroceryTab = tab;
            document.getElementById('tabGrocery').classList.toggle('active', tab === 'grocery');
            document.getElementById('tabFridge').classList.toggle('active', tab === 'fridge');
            document.getElementById('groceryTabContent').classList.toggle('active', tab === 'grocery');
            document.getElementById('fridgeTabContent').classList.toggle('active', tab === 'fridge');
            document.getElementById('groceryPageTitle').textContent = tab === 'grocery' ? 'Grocery List' : 'My Fridge';

            if (tab === 'fridge') {
                loadFridgePage();
            }
        }

        function clearCurrentSection() {
            if (currentGroceryTab === 'grocery') {
                clearFullGroceryList();
            } else {
                clearFridge();
            }
        }

        // ==================== FRIDGE PAGE ====================
        async function loadFridgePage() {
            try {
                const items = await TenderAPI.getFridgeItems();
                renderFridgePage(items);
            } catch (err) {
                console.error('Failed to load fridge:', err);
            }
        }

        function renderFridgePage(items) {
            document.getElementById('fridgeTotalItems').textContent = items.length;

            const container = document.getElementById('fridgeFullList');

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 60px 20px;">
                        <div class="icon"></div>
                        <p>Your fridge is empty.<br>Add items manually or scan a photo of your fridge!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="fridge-item">
                    <span class="item-name">${escapeHtml(item.name)}</span>
                    ${item.quantity > 1 ? `<span class="item-quantity">x${item.quantity}</span>` : ''}
                    ${item.category && item.category !== 'Other' ? `<span class="item-category">${escapeHtml(item.category)}</span>` : ''}
                    <button class="item-delete" onclick="deleteFridgeItem(${item.id})"></button>
                </div>
            `).join('');
        }

        async function addFridgeItemManual(e) {
            e.preventDefault();
            const nameInput = document.getElementById('newFridgeName');
            const qtyInput = document.getElementById('newFridgeQty');
            const name = nameInput.value.trim();
            const quantity = parseInt(qtyInput.value) || 1;

            if (!name) return;

            try {
                await TenderAPI.addFridgeItem({ name, quantity });
                nameInput.value = '';
                qtyInput.value = '1';
                loadFridgePage();
            } catch (err) {
                console.error('Failed to add fridge item:', err);
            }
        }

        async function deleteFridgeItem(id) {
            try {
                await TenderAPI.deleteFridgeItem(id);
                loadFridgePage();
            } catch (err) {
                console.error('Failed to delete fridge item:', err);
            }
        }

        async function clearFridge() {
            const ok = await showConfirm({
                icon: '',
                title: 'Clear Fridge?',
                message: 'This will remove all items from your fridge inventory. This action cannot be undone.',
                confirmText: 'Clear All'
            });
            if (ok) {
                try {
                    await TenderAPI.clearFridge();
                    loadFridgePage();
                } catch (err) {
                    console.error('Failed to clear fridge:', err);
                }
            }
        }

        // ==================== FRIDGE SCANNING ====================
        let scanResults = [];

        function triggerFridgeScan() {
            document.getElementById('fridgeImageInput').click();
        }

        async function handleFridgeImage(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Show loading state in modal
            const modal = document.getElementById('scanModal');
            const body = document.getElementById('scanModalBody');
            modal.classList.add('active');
            body.innerHTML = `
                <div class="scan-loading">
                    <div class="spinner"></div>
                    <p>Analyzing your fridge...</p>
                    <p style="color: #aaa; font-size: 0.85em;">This may take a few seconds</p>
                </div>
            `;

            // Convert to base64
            const reader = new FileReader();
            reader.onload = async function(event) {
                const base64 = event.target.result.split(',')[1]; // Remove data:image/...;base64, prefix

                try {
                    const data = await TenderAPI.scanFridgeImage(base64);
                    scanResults = data.ingredients || [];
                    showScanResults(scanResults);
                } catch (err) {
                    console.error('Scan failed:', err);
                    body.innerHTML = `
                        <div class="scan-loading">
                            <div class="icon" style="font-size: 3em; margin-bottom: 15px;"></div>
                            <p>Failed to analyze image</p>
                            <p style="color: #aaa; font-size: 0.85em;">${escapeHtml(err.message)}</p>
                        </div>
                    `;
                }
            };
            reader.readAsDataURL(file);

            // Reset the input so the same file can be selected again
            e.target.value = '';
        }

        function showScanResults(ingredients) {
            const body = document.getElementById('scanModalBody');

            if (ingredients.length === 0) {
                body.innerHTML = `
                    <div class="scan-loading">
                        <div class="icon" style="font-size: 3em; margin-bottom: 15px;"></div>
                        <p>No ingredients found</p>
                        <p style="color: #aaa; font-size: 0.85em;">Try taking a clearer photo with better lighting</p>
                    </div>
                `;
                return;
            }

            body.innerHTML = ingredients.map((item, i) => `
                <div class="scan-item">
                    <input type="checkbox" checked id="scanItem${i}" data-index="${i}">
                    <span class="scan-item-name">${escapeHtml(item.name)}</span>
                    ${item.quantity > 1 ? `<span class="scan-item-qty">x${item.quantity}</span>` : ''}
                    ${item.category ? `<span class="scan-item-category">${escapeHtml(item.category)}</span>` : ''}
                </div>
            `).join('');
        }

        async function confirmScanResults() {
            const checkboxes = document.querySelectorAll('#scanModalBody input[type="checkbox"]');
            const itemsToAdd = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const idx = parseInt(cb.dataset.index);
                    itemsToAdd.push(scanResults[idx]);
                }
            });

            // Add each selected item to the fridge
            for (const item of itemsToAdd) {
                try {
                    await TenderAPI.addFridgeItem({
                        name: item.name,
                        quantity: item.quantity || 1,
                        category: item.category || 'Other'
                    });
                } catch (err) {
                    console.error('Failed to add scanned item:', err);
                }
            }

            closeScanModal();
            loadFridgePage();
        }

        function closeScanModal() {
            document.getElementById('scanModal').classList.remove('active');
            scanResults = [];
        }

        // ==================== DASHBOARD GROCERY (quick actions) ====================
        async function addGroceryItemQuick(e) {
            e.preventDefault();
            const input = document.getElementById('newGroceryItemQuick');
            const name = input.value.trim();
            if (!name) return;

            try {
                await TenderAPI.addGroceryItem({ name, quantity: 1 });
                input.value = '';
                loadGroceryPreview();
                // Update stat
                const stats = await TenderAPI.getStats();
                document.getElementById('groceryCount').textContent = stats.groceryCount;
            } catch (err) {
                console.error('Failed to add item:', err);
            }
        }

        async function toggleGroceryItem(itemId) {
            try {
                await TenderAPI.toggleGroceryItem(itemId);
                loadGroceryPreview();
            } catch (err) {
                console.error('Failed to toggle item:', err);
            }
        }

        async function deleteGroceryItem(itemId) {
            try {
                await TenderAPI.deleteGroceryItem(itemId);
                loadGroceryPreview();
                const stats = await TenderAPI.getStats();
                document.getElementById('groceryCount').textContent = stats.groceryCount;
            } catch (err) {
                console.error('Failed to delete item:', err);
            }
        }

        // ==================== UTILITY ====================
        function logout() {
            localStorage.clear();
            window.location.replace('tender.html');
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Close modals on overlay click
        document.getElementById('recipeModal').addEventListener('click', function(e) {
            if (e.target === this) closeRecipeModal();
        });
        document.getElementById('addMealModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddMealModal();
        });

        // ==================== INITIALIZE ====================
        updateThemeToggleUI();
        loadDashboard();
    </script>

    <!-- DB Dump Overlay -->
    <div class="db-dump-overlay" id="dbDumpOverlay" onclick="handleDumpOverlayClick(event)">
        <div class="db-dump-container">
            <div class="db-dump-titlebar">
                <div class="title-dots">
                    <span onclick="closeDbDump()"></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="title-name">tender.db  raw database dump</div>
                <button class="db-dump-close" onclick="closeDbDump()"></button>
            </div>
            <div class="db-dump-toolbar">
                <button class="db-dump-copy-btn" onclick="copyDbDump()">Copy All</button>
                <input type="text" class="db-dump-search" placeholder="Find in dump..." oninput="highlightDumpSearch(this.value)" id="dumpSearchInput">
                <span class="db-dump-info" id="dbDumpInfo">loading...</span>
            </div>
            <pre class="db-dump-pre" id="dbDumpPre">Loading database dump...</pre>
        </div>
    </div>
</body>
</html>

